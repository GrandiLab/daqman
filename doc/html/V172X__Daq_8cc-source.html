<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>daqman: daq/src/V172X_Daq.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_c976ee0ae87b6728a83ed7ade4473415.html">daq</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e3dd35d4c93a0559abedf62cd98e4d2d.html">src</a></div>
<h1>V172X_Daq.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* --------------------------------------------------------</span>
<a name="l00002"></a>00002 <span class="comment">CAEN_V172XDAQ.cc</span>
<a name="l00003"></a>00003 <span class="comment">This is the implementation for the CAEN_V172XDAQ class, </span>
<a name="l00004"></a>00004 <span class="comment">which inherits from the WARP_VetoDAQ class.</span>
<a name="l00005"></a>00005 <span class="comment">----------------------------------------------------------*/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="V172X__Daq_8hh.html">V172X_Daq.hh</a>"</span>
<a name="l00008"></a>00008 <span class="comment">//#include "CAEN_V172XEvent.hh"</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include "CAENVMElib.h"</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="RawEvent_8hh.html">RawEvent.hh</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="Message_8hh.html">Message.hh</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "<a class="code" href="ConfigHandler_8hh.html">ConfigHandler.hh</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="EventHandler_8hh.html">EventHandler.hh</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="RunDB_8hh.html">RunDB.hh</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;bitset&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "boost/ref.hpp"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "boost/timer.hpp"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "boost/date_time/posix_time/posix_time_duration.hpp"</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">//declare some useful constants</span>
<a name="l00024"></a>00024 <span class="keyword">const</span> <span class="keywordtype">int</span> event_size_padding = 8;
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="keyword">enum</span> VME_REGISTERS{
<a name="l00027"></a>00027   VME_ChZSThresh =         0x1024,
<a name="l00028"></a>00028   VME_ChZSNsamples =       0x1028,
<a name="l00029"></a>00029   VME_ChTrigThresh =       0x1080,
<a name="l00030"></a>00030   VME_ChTrigSamples =      0x1084,
<a name="l00031"></a>00031   VME_ChStatus =           0x1088,
<a name="l00032"></a>00032   VME_ChBuffersFull =      0x1094,
<a name="l00033"></a>00033   VME_ChDAC =              0x1098,
<a name="l00034"></a>00034   VME_ChannelsConfig =     0x8000,
<a name="l00035"></a>00035   VME_BufferCode =         0x800C,
<a name="l00036"></a>00036   VME_BufferFree =         0x8010,
<a name="l00037"></a>00037   VME_CustomSize =         0x8020,
<a name="l00038"></a>00038   VME_AcquisitionControl = 0x8100,
<a name="l00039"></a>00039   VME_AcquisitionStatus =  0x8104,
<a name="l00040"></a>00040   VME_SWTrigger =          0x8108,
<a name="l00041"></a>00041   VME_TrigSourceMask =     0x810C,
<a name="l00042"></a>00042   VME_TrigOutMask =        0x8110,
<a name="l00043"></a>00043   VME_PostTriggerSetting = 0x8114,
<a name="l00044"></a>00044   VME_FrontPanelIO =       0x811C,
<a name="l00045"></a>00045   VME_ChannelMask =        0x8120,
<a name="l00046"></a>00046   VME_DownsampleFactor =   0x8128,
<a name="l00047"></a>00047   VME_EventsStored =       0x812C,
<a name="l00048"></a>00048   VME_BoardInfo =          0x8140,
<a name="l00049"></a>00049   VME_EventSize =          0x814C,
<a name="l00050"></a>00050   VME_VMEControl =         0xEF00,
<a name="l00051"></a>00051   VME_VMEStatus =          0xEF04,
<a name="l00052"></a>00052   VME_BoardID =            0xEF08,
<a name="l00053"></a>00053   VME_RelocationAddress =  0xEF10,
<a name="l00054"></a>00054   VME_InterruptID =        0xEF14,
<a name="l00055"></a>00055   VME_InterruptOnEvent =   0xEF18,
<a name="l00056"></a>00056   VME_BLTEvents =          0xEF1C,
<a name="l00057"></a>00057   VME_SWReset =            0xEF24,
<a name="l00058"></a>00058   VME_SWClear =            0xEF28,
<a name="l00059"></a>00059 };
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="classV172X__Daq.html#ffd654241f8ba6beabd6ec037ed39d1a">00061</a> <a class="code" href="classV172X__Daq.html#ffd654241f8ba6beabd6ec037ed39d1a">V172X_Daq::V172X_Daq</a>() : <a class="code" href="classBaseDaq.html">BaseDaq</a>(), _initialized(false), 
<a name="l00062"></a>00062                          _params(), _triggers(0), _vme_mutex()
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <a class="code" href="classConfigHandler.html#a014f0691bfd8b19256b14796e8f2610">ConfigHandler::GetInstance</a>()-&gt;<a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classVParameterNode.html#d84847c0c43b2feca44840c8f6346df7">GetDefaultKey</a>(),
<a name="l00065"></a>00065                                                   <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>);
<a name="l00066"></a>00066   <a class="code" href="classV172X__Daq.html#1cb7dfe53837ed1cb9686cf70d446e1a">_handle_vme_bridge</a> = 0;
<a name="l00067"></a>00067   std::fill (<a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a> + <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#39fce0d8eb0869d8b5c9b8596c9b7700">nboards</a>, 0);
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="classV172X__Daq.html#cb1847daf8edea1ca20d7f5f8ef29bc4">00070</a> <a class="code" href="classV172X__Daq.html#cb1847daf8edea1ca20d7f5f8ef29bc4">V172X_Daq::~V172X_Daq</a>()
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072   <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#d743f043d73f01d77fa4a9cb39235ea5">vme_bridge_link</a> &gt;= 0) CAENVME_End(<a class="code" href="classV172X__Daq.html#1cb7dfe53837ed1cb9686cf70d446e1a">_handle_vme_bridge</a>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#39fce0d8eb0869d8b5c9b8596c9b7700">nboards</a>; i++)
<a name="l00075"></a>00075     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#66b10413b8e533ee0f879e1a4c4d1198">enabled</a> &amp;&amp; <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#3ea82f5585a422a5a2b2446acdcc9271">link</a> &gt; 0 &amp;&amp; <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#3ea82f5585a422a5a2b2446acdcc9271">link</a> != <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#d743f043d73f01d77fa4a9cb39235ea5">vme_bridge_link</a>) CAENVME_End(<a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[i]);
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="keywordtype">int</span> init_link (<span class="keywordtype">int</span> link, int32_t *handle) {
<a name="l00079"></a>00079   CVErrorCodes err = CAENVME_Init(cvV2718, link, 0, handle);
<a name="l00080"></a>00080   <span class="keywordflow">if</span>(err != cvSuccess){
<a name="l00081"></a>00081     <a class="code" href="classMessage.html">Message</a> m(ERROR);
<a name="l00082"></a>00082     m&lt;&lt;<span class="stringliteral">"Unable to initialize CAEN VME bridge for link "</span> &lt;&lt; link &lt;&lt; <span class="stringliteral">": "</span>&lt;&lt;std::endl;
<a name="l00083"></a>00083     m&lt;&lt;<span class="stringliteral">"\t"</span>&lt;&lt;CAENVME_DecodeError(err)&lt;&lt;std::endl;
<a name="l00084"></a>00084     <span class="keywordflow">return</span> -1;
<a name="l00085"></a>00085   }
<a name="l00086"></a>00086   <span class="keywordtype">char</span> message[100];
<a name="l00087"></a>00087   <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"CAEN VME bridge successfully initialized for link "</span> &lt;&lt; link &lt;&lt; <span class="stringliteral">"!"</span>&lt;&lt;std::endl;
<a name="l00088"></a>00088   CAENVME_BoardFWRelease(*handle,message);
<a name="l00089"></a>00089   <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"\tFirmware Release: "</span>&lt;&lt;message&lt;&lt;std::endl;
<a name="l00090"></a>00090   CAENVME_DriverRelease(*handle,message);
<a name="l00091"></a>00091   <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"\tDriver Release: "</span>&lt;&lt;message&lt;&lt;std::endl;
<a name="l00092"></a>00092   <a class="code" href="classMessage.html">Message</a>(INFO)&lt;&lt; <span class="stringliteral">"Link "</span> &lt;&lt; link &lt;&lt; <span class="stringliteral">" initialized on handle "</span> &lt;&lt; *handle &lt;&lt;std::endl;
<a name="l00093"></a>00093   <span class="keywordflow">return</span> 0;
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="classV172X__Daq.html#0600101d6215d2c143e7022e55ed44bd">00097</a> <span class="keywordtype">int</span> <a class="code" href="classV172X__Daq.html#0600101d6215d2c143e7022e55ed44bd">V172X_Daq::Initialize</a>()
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099   <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#fbaee15650b78da67e46cbd2ecd91b67">_initialized</a>){
<a name="l00100"></a>00100     <a class="code" href="classMessage.html">Message</a>(WARNING)&lt;&lt;<span class="stringliteral">"Reinitializing V172X_Daq..."</span>&lt;&lt;std::endl;
<a name="l00101"></a>00101     <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#d743f043d73f01d77fa4a9cb39235ea5">vme_bridge_link</a> &gt;= 0) CAENVME_End(<a class="code" href="classV172X__Daq.html#1cb7dfe53837ed1cb9686cf70d446e1a">_handle_vme_bridge</a>);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#39fce0d8eb0869d8b5c9b8596c9b7700">nboards</a>; i++)
<a name="l00104"></a>00104       <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#66b10413b8e533ee0f879e1a4c4d1198">enabled</a> &amp;&amp; <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#3ea82f5585a422a5a2b2446acdcc9271">link</a> &gt; 0 &amp;&amp; <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#3ea82f5585a422a5a2b2446acdcc9271">link</a> != <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#d743f043d73f01d77fa4a9cb39235ea5">vme_bridge_link</a>) CAENVME_End(<a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[i]);
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106       
<a name="l00107"></a>00107   <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#d743f043d73f01d77fa4a9cb39235ea5">vme_bridge_link</a> &gt;= 0) {
<a name="l00108"></a>00108     if (init_link (<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#d743f043d73f01d77fa4a9cb39235ea5">vme_bridge_link</a>, &amp;<a class="code" href="classV172X__Daq.html#1cb7dfe53837ed1cb9686cf70d446e1a">_handle_vme_bridge</a>) &lt; 0) {
<a name="l00109"></a>00109       <a class="code" href="classBaseDaq.html#231f99398eeec02f020d57962926cdbe">_status</a>=<a class="code" href="classBaseDaq.html#6d79d523b3df7acbc38fc006b8b3600a5d0fd9dfb083002684f010497c2122f3">INIT_FAILURE</a>;
<a name="l00110"></a>00110       <span class="keywordflow">return</span> -1;
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112     <span class="comment">//reset everything</span>
<a name="l00113"></a>00113     <span class="comment">//CAENVME_SystemReset(_handle_vme_bridge);</span>
<a name="l00114"></a>00114     <span class="comment">//CAENVME_DeviceReset(_handle_vme_bridge);</span>
<a name="l00115"></a>00115     <span class="keywordflow">if</span>(_params.send_start_pulse) {
<a name="l00116"></a>00116       CAENVME_ClearOutputRegister(_handle_vme_bridge, 0xFFFF);
<a name="l00117"></a>00117       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> line = 0; line&lt;5; line++){
<a name="l00118"></a>00118         CVErrorCodes err = CAENVME_SetOutputConf(_handle_vme_bridge, (CVOutputSelect)line, cvDirect, 
<a name="l00119"></a>00119             cvActiveHigh, cvManualSW);
<a name="l00120"></a>00120         <span class="keywordflow">if</span>(err != cvSuccess){
<a name="l00121"></a>00121           <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Unable to configure the V2718 output registers.\n"</span>;
<a name="l00122"></a>00122           <span class="keywordflow">return</span> -2;
<a name="l00123"></a>00123         }
<a name="l00124"></a>00124       }
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126   } 
<a name="l00127"></a>00127   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_params.send_start_pulse) {
<a name="l00128"></a>00128     <a class="code" href="classMessage.html">Message</a>(WARNING)&lt;&lt;<span class="stringliteral">"send_start_pulse enabled but no bridge link present, disabling pulses"</span> &lt;&lt; std::endl;
<a name="l00129"></a>00129     _params.send_start_pulse = 0;
<a name="l00130"></a>00130   }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; _params.nboards; i++) {
<a name="l00133"></a>00133     <span class="keywordflow">if</span>(_params.board[i].enabled &amp;&amp; _params.board[i].link &gt;= 0 &amp;&amp; _params.board[i].link != _params.vme_bridge_link) {
<a name="l00134"></a>00134       if (init_link (_params.board[i].link, _handle_board + i) &lt; 0) {
<a name="l00135"></a>00135         _status=INIT_FAILURE;
<a name="l00136"></a>00136         <span class="keywordflow">return</span> -3;
<a name="l00137"></a>00137       }
<a name="l00138"></a>00138     } 
<a name="l00139"></a>00139     <span class="keywordflow">else</span> _handle_board[i] = _handle_vme_bridge;
<a name="l00140"></a>00140   }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; _params.nboards; i++){
<a name="l00143"></a>00143     <span class="comment">//Initialize each enabled board</span>
<a name="l00144"></a>00144     <span class="keywordflow">if</span>(!_params.board[i].enabled) 
<a name="l00145"></a>00145       <span class="keywordflow">continue</span>;
<a name="l00146"></a>00146     <span class="keywordflow">try</span>{
<a name="l00147"></a>00147       <span class="keywordflow">if</span>(InitializeBoard(i)){
<a name="l00148"></a>00148         _status = INIT_FAILURE;
<a name="l00149"></a>00149         <span class="keywordflow">return</span> -5;
<a name="l00150"></a>00150       }
<a name="l00151"></a>00151       
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153     <span class="keywordflow">catch</span>(std::exception &amp;error)
<a name="l00154"></a>00154       {
<a name="l00155"></a>00155         <a class="code" href="classMessage.html">Message</a>(EXCEPTION)&lt;&lt;error.what()&lt;&lt;std::endl;
<a name="l00156"></a>00156         <span class="keywordflow">return</span> -6;
<a name="l00157"></a>00157       }
<a name="l00158"></a>00158   }
<a name="l00159"></a>00159   _initialized = <span class="keyword">true</span>;
<a name="l00160"></a>00160   <span class="keywordflow">return</span> Update();
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="classV172X__Daq.html#632f58ec4f155f9732134f9fd2bcd2c8">00163</a> <span class="keywordtype">int</span> <a class="code" href="classV172X__Daq.html#632f58ec4f155f9732134f9fd2bcd2c8">V172X_Daq::InitializeBoard</a>(<span class="keywordtype">int</span> boardnum)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165   <a class="code" href="classV172X__BoardParams.html">V172X_BoardParams</a>&amp; board = <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[boardnum];
<a name="l00166"></a>00166   <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ce8a5ebb74dd3409a8ce8843e81fcd50">address</a> + VME_SWReset, 1, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[boardnum]);
<a name="l00167"></a>00167   uint32_t data = <a class="code" href="classV172X__Daq.html#9ab57138d4b5f5ba2c14b85060cfdaa4">ReadVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ce8a5ebb74dd3409a8ce8843e81fcd50">address</a>+VME_BoardInfo, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[boardnum]);
<a name="l00168"></a>00168   board.<a class="code" href="classV172X__BoardParams.html#153220c43c585f937cec14cd080d81e3">board_type</a> = (<a class="code" href="group__daqman.html#g6423298fc4fa51a1962a0c26b3baa2a1">BOARD_TYPE</a>)(data&amp;0xFF);
<a name="l00169"></a>00169   board.<a class="code" href="classV172X__BoardParams.html#a83fdc64ebcbc39b0de854ac8f04d4d2">mem_size</a> = (data&gt;&gt;8)&amp;0xFF;
<a name="l00170"></a>00170   <span class="keywordflow">if</span>(board.<a class="code" href="classV172X__BoardParams.html#55773357f01342a8b00ea0ef5b7e050e">UpdateBoardSpecificVariables</a>()){ <span class="comment">//returns -1 on error</span>
<a name="l00171"></a>00171     <a class="code" href="classMessage.html">Message</a>(CRITICAL)&lt;&lt;<span class="stringliteral">"Board "</span>&lt;&lt;boardnum&lt;&lt;<span class="stringliteral">" with address "</span>
<a name="l00172"></a>00172                      &lt;&lt;std::hex&lt;&lt;std::showbase
<a name="l00173"></a>00173                      &lt;&lt;board.<a class="code" href="classV172X__BoardParams.html#ce8a5ebb74dd3409a8ce8843e81fcd50">address</a>&lt;&lt;std::dec&lt;&lt;std::noshowbase
<a name="l00174"></a>00174                      &lt;&lt;<span class="stringliteral">" is not a V172X digitizer!"</span>&lt;&lt;std::endl;
<a name="l00175"></a>00175     <a class="code" href="classBaseDaq.html#231f99398eeec02f020d57962926cdbe">_status</a> = <a class="code" href="classBaseDaq.html#6d79d523b3df7acbc38fc006b8b3600a5d0fd9dfb083002684f010497c2122f3">INIT_FAILURE</a>;
<a name="l00176"></a>00176     <span class="keywordflow">return</span> -2;
<a name="l00177"></a>00177   }
<a name="l00178"></a>00178   <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ce8a5ebb74dd3409a8ce8843e81fcd50">address</a>+VME_BoardID,
<a name="l00179"></a>00179                    board.<a class="code" href="classV172X__BoardParams.html#401f8f5645ab09bffafa861bd0910efd">id</a>, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[boardnum]);
<a name="l00180"></a>00180   <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ce8a5ebb74dd3409a8ce8843e81fcd50">address</a>+VME_InterruptID,
<a name="l00181"></a>00181                    board.<a class="code" href="classV172X__BoardParams.html#401f8f5645ab09bffafa861bd0910efd">id</a>, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[boardnum]);
<a name="l00182"></a>00182   <span class="keywordflow">return</span> 0;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="classV172X__Daq.html#415f5bb68331689e007c9801073cd943">00185</a> <span class="keywordtype">int</span> <a class="code" href="classV172X__Daq.html#415f5bb68331689e007c9801073cd943">V172X_Daq::Update</a>()
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187   <span class="keywordflow">if</span>(!<a class="code" href="classV172X__Daq.html#fbaee15650b78da67e46cbd2ecd91b67">_initialized</a>){
<a name="l00188"></a>00188     <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Attempt to update parameters before initializations!"</span>
<a name="l00189"></a>00189                   &lt;&lt;std::endl;
<a name="l00190"></a>00190     <span class="keywordflow">return</span> -1;
<a name="l00191"></a>00191   }
<a name="l00192"></a>00192   <span class="keywordflow">if</span>(<a class="code" href="classBaseDaq.html#2a3eb7573c21e7107a48fd91fee64253">_is_running</a>){
<a name="l00193"></a>00193     <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Attempt to update parameters while in run."</span>
<a name="l00194"></a>00194                   &lt;&lt;std::endl;
<a name="l00195"></a>00195     <span class="keywordflow">return</span> -2;
<a name="l00196"></a>00196   }
<a name="l00197"></a>00197   <span class="keywordflow">try</span>{
<a name="l00198"></a>00198     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iboard=0; iboard &lt; <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#39fce0d8eb0869d8b5c9b8596c9b7700">nboards</a>; iboard++){
<a name="l00199"></a>00199       <a class="code" href="classV172X__BoardParams.html">V172X_BoardParams</a>&amp; board = <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[iboard];
<a name="l00200"></a>00200       <span class="comment">//downsample factor is not implemented in modern firmware</span>
<a name="l00201"></a>00201       board.<a class="code" href="classV172X__BoardParams.html#03e80c12cc870afaf0186fedc2b7ef1d">downsample_factor</a>=1; 
<a name="l00202"></a>00202       <span class="keywordflow">if</span>(!board.enabled) 
<a name="l00203"></a>00203         <span class="keywordflow">continue</span>;
<a name="l00204"></a>00204       <span class="comment">//determine the trigger acquisition window for the database</span>
<a name="l00205"></a>00205       <span class="comment">//WARNING: Assumes it is the same for all boards!!!</span>
<a name="l00206"></a>00206       <a class="code" href="classRunDB_1_1runinfo.html">RunDB::runinfo</a>* info = <a class="code" href="classEventHandler.html#82a06f8d55b44d8d163b6473ea07f1a8">EventHandler::GetInstance</a>()-&gt;<a class="code" href="classEventHandler.html#54ecc6c1be41001e27d5bdd8a03d8f0b">GetRunInfo</a>();
<a name="l00207"></a>00207       <span class="keywordflow">if</span>(info){
<a name="l00208"></a>00208         info-&gt;<a class="code" href="classRunDB_1_1runinfo.html#08982bcd08358c88436afc46e11082ac">pre_trigger_time_us</a> = board.pre_trigger_time_us;
<a name="l00209"></a>00209         info-&gt;post_trigger_time_us = board.post_trigger_time_us;
<a name="l00210"></a>00210       }
<a name="l00211"></a>00211        
<a name="l00212"></a>00212       uint32_t channel_mask = 0;
<a name="l00213"></a>00213       uint32_t trigger_mask = 0;
<a name="l00214"></a>00214       uint32_t trigger_out_mask = 0;
<a name="l00215"></a>00215       <span class="comment">//need to know total_nsamps to estimate event size</span>
<a name="l00216"></a>00216       <span class="comment">//do the per-channel stuff</span>
<a name="l00217"></a>00217       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;board.nchans; i++){
<a name="l00218"></a>00218         <a class="code" href="classV172X__ChannelParams.html">V172X_ChannelParams</a>&amp; channel = board.channel[i];
<a name="l00219"></a>00219         channel_mask += (1&lt;&lt;i) * channel.enabled;
<a name="l00220"></a>00220         trigger_mask += (1&lt;&lt;i) * channel.enable_trigger_source;
<a name="l00221"></a>00221         trigger_out_mask += (1&lt;&lt;i) * channel.enable_trigger_out;
<a name="l00222"></a>00222         <span class="comment">//write the per-channel stuff</span>
<a name="l00223"></a>00223         <span class="comment">//Zero suppression threshold</span>
<a name="l00224"></a>00224         uint32_t zs_thresh = (1&lt;&lt;31) * channel.zs_polarity +
<a name="l00225"></a>00225           channel.zs_threshold;
<a name="l00226"></a>00226         <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+VME_ChZSThresh+i*0x100,zs_thresh, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00227"></a>00227         <span class="comment">//zero suppression time over threshold</span>
<a name="l00228"></a>00228         uint32_t nsamp = channel.zs_thresh_time_us * board.GetSampleRate();
<a name="l00229"></a>00229         <span class="keywordflow">if</span>(nsamp &gt;= (1&lt;&lt;20)) nsamp = (1&lt;&lt;20) -1;
<a name="l00230"></a>00230         <span class="keywordflow">if</span>(board.zs_type == ZLE){
<a name="l00231"></a>00231           <span class="comment">//nsamp contains the pre and post samples</span>
<a name="l00232"></a>00232           <span class="keywordflow">if</span>(channel.zs_pre_samps&gt;=(1&lt;&lt;16)) channel.zs_pre_samps = (1&lt;&lt;16)-1;
<a name="l00233"></a>00233           <span class="keywordflow">if</span>(channel.zs_post_samps&gt;=(1&lt;&lt;16)) channel.zs_post_samps = (1&lt;&lt;16)-1;
<a name="l00234"></a>00234           uint32_t npre = 
<a name="l00235"></a>00235             std::ceil(channel.zs_pre_samps/board.stupid_size_factor);
<a name="l00236"></a>00236           uint32_t npost = 
<a name="l00237"></a>00237             std::ceil(channel.zs_pre_samps/board.stupid_size_factor);
<a name="l00238"></a>00238           nsamp = (npre&lt;&lt;16) + npost;
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240         <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_ChZSNsamples+i*0x100, nsamp, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00241"></a>00241         <span class="comment">//trigger threshold</span>
<a name="l00242"></a>00242         <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_ChTrigThresh+i*0x100, 
<a name="l00243"></a>00243                          channel.threshold, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00244"></a>00244         <span class="comment">//time over trigger threhsold</span>
<a name="l00245"></a>00245         nsamp = std::ceil(channel.thresh_time_us * board.GetSampleRate()) 
<a name="l00246"></a>00246           / board.stupid_size_factor;
<a name="l00247"></a>00247         
<a name="l00248"></a>00248         <span class="keywordflow">if</span>(nsamp &gt;= (1&lt;&lt;12)) nsamp = (1&lt;&lt;12) - 1;
<a name="l00249"></a>00249         <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_ChTrigSamples+i*0x100, nsamp, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00250"></a>00250         <span class="comment">//dc offset</span>
<a name="l00251"></a>00251         <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_ChDAC+i*0x100, channel.dc_offset, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00252"></a>00252         <span class="comment">//wait until the dac has updated</span>
<a name="l00253"></a>00253         uint32_t status = 0x4;
<a name="l00254"></a>00254         <span class="keywordflow">while</span>( channel.enabled &amp;&amp;( (status&amp;0x4) || !(status&amp;0x2)) ){
<a name="l00255"></a>00255           <span class="comment">//std::cerr&lt;&lt;"Waiting for channel "&lt;&lt;i&lt;&lt;" of board "&lt;&lt;iboard&lt;&lt;" to update DAC...";</span>
<a name="l00256"></a>00256           status = <a class="code" href="classV172X__Daq.html#9ab57138d4b5f5ba2c14b85060cfdaa4">ReadVMERegister</a>(board.address+VME_ChStatus +i*0x100, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00257"></a>00257           <span class="comment">//std::cerr&lt;&lt;" status is now "&lt;&lt;status&lt;&lt;std::endl;</span>
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259       }
<a name="l00260"></a>00260       <span class="comment">//finish up with the board parameters</span>
<a name="l00261"></a>00261       uint32_t channel_config = (1&lt;&lt;16) * board.zs_type + 
<a name="l00262"></a>00262         (1&lt;&lt;6) * board.trigger_polarity + 
<a name="l00263"></a>00263         (1&lt;&lt;4) + <span class="comment">//Memory Sequential access</span>
<a name="l00264"></a>00264         (1&lt;&lt;3) * board.enable_test_pattern + 
<a name="l00265"></a>00265         (1&lt;&lt;1) * board.enable_trigger_overlap;
<a name="l00266"></a>00266       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_ChannelsConfig, channel_config, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00267"></a>00267       <span class="comment">//Buffer code (determines total trigger time</span>
<a name="l00268"></a>00268       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+VME_BufferCode, board.GetBufferCode(), <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00269"></a>00269       <span class="comment">//Custom size of register</span>
<a name="l00270"></a>00270       
<a name="l00271"></a>00271       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_CustomSize, 
<a name="l00272"></a>00272                        board.GetCustomSizeSetting(), <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00273"></a>00273       
<a name="l00274"></a>00274       <span class="comment">//Acquisition Control</span>
<a name="l00275"></a>00275       uint32_t acq_control =  
<a name="l00276"></a>00276         (1&lt;&lt;3) * board.count_all_triggers +
<a name="l00277"></a>00277         <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#39778fccabd270f58585798100feca91">send_start_pulse</a>;
<a name="l00278"></a>00278 <span class="comment">//      acq_control = (1&lt;&lt;3) * board.count_all_triggers + 4;</span>
<a name="l00279"></a>00279       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+VME_AcquisitionControl,acq_control, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00280"></a>00280       board.acq_control_val = acq_control;
<a name="l00281"></a>00281       <span class="comment">//trigger mask</span>
<a name="l00282"></a>00282       <span class="keywordflow">if</span>(board.local_trigger_coincidence &gt;7) 
<a name="l00283"></a>00283         board.local_trigger_coincidence = 7;
<a name="l00284"></a>00284       trigger_mask += (1&lt;&lt;31) * board.enable_software_trigger 
<a name="l00285"></a>00285         + (1&lt;&lt;30) * board.enable_external_trigger
<a name="l00286"></a>00286         + (1&lt;&lt;24) * board.local_trigger_coincidence;
<a name="l00287"></a>00287       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_TrigSourceMask, trigger_mask, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00288"></a>00288       <span class="comment">//trigger out mask</span>
<a name="l00289"></a>00289       trigger_out_mask += (1&lt;&lt;31) * board.enable_software_trigger_out +
<a name="l00290"></a>00290         (1&lt;&lt;30) * board.enable_external_trigger_out;
<a name="l00291"></a>00291       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_TrigOutMask, trigger_out_mask, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00292"></a>00292       <span class="comment">//post trigger setting</span>
<a name="l00293"></a>00293       
<a name="l00294"></a>00294       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+VME_PostTriggerSetting, 
<a name="l00295"></a>00295                        board.GetPostTriggerSetting(), <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00296"></a>00296       <span class="comment">//signal logic and front panel programming</span>
<a name="l00297"></a>00297       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_FrontPanelIO,
<a name="l00298"></a>00298                        board.signal_logic + (1&lt;&lt;6), <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00299"></a>00299       <span class="comment">//channel mask</span>
<a name="l00300"></a>00300       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_ChannelMask, channel_mask, 
<a name="l00301"></a>00301                        <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00302"></a>00302       <span class="comment">//VME control</span>
<a name="l00303"></a>00303       uint32_t vme_control = (1&lt;&lt;5) * <a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#f17f68bdbb27446e2607d8dc71527dd4">align64</a> + 
<a name="l00304"></a>00304         (1&lt;&lt;4) + <span class="comment">//enable bus error</span>
<a name="l00305"></a>00305         (1&lt;&lt;3) + <span class="comment">//enable optical link error</span>
<a name="l00306"></a>00306         1; <span class="comment">//interrupt level</span>
<a name="l00307"></a>00307       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+ VME_VMEControl, vme_control, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00308"></a>00308       <span class="comment">//Interrupt num, BLT event num</span>
<a name="l00309"></a>00309       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+VME_InterruptOnEvent, 0, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00310"></a>00310       <a class="code" href="classV172X__Daq.html#0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.address+VME_BLTEvents, 1, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00311"></a>00311       <span class="comment">//wait until the board is ready to take data</span>
<a name="l00312"></a>00312       uint32_t status = 0;
<a name="l00313"></a>00313       <span class="keywordtype">int</span> count = 0;
<a name="l00314"></a>00314       <span class="keywordflow">while</span>( !((status&amp;0x100) &amp;&amp; (status&amp;0xc0)) ){
<a name="l00315"></a>00315         status = <a class="code" href="classV172X__Daq.html#9ab57138d4b5f5ba2c14b85060cfdaa4">ReadVMERegister</a>(board.address+VME_AcquisitionStatus, <a class="code" href="classV172X__Daq.html#3f521df2e13624dd150084e1e61cf7fa">_handle_board</a>[iboard]);
<a name="l00316"></a>00316         <span class="keywordflow">if</span>(count++ &gt; 500){
<a name="l00317"></a>00317           <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Unable to initialize board "</span>&lt;&lt;iboard&lt;&lt;<span class="stringliteral">" at address "</span>
<a name="l00318"></a>00318                         &lt;&lt;std::hex&lt;&lt;board.address&lt;&lt;std::dec&lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00319"></a>00319           <span class="keywordflow">return</span> 1;
<a name="l00320"></a>00320         }
<a name="l00321"></a>00321       }
<a name="l00322"></a>00322       
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324     <span class="comment">/*Find the max expected event size in bytes</span>
<a name="l00325"></a>00325 <span class="comment">    The header size is 16 bytes per board</span>
<a name="l00326"></a>00326 <span class="comment">    The data size is 2 bytes per sample per channel</span>
<a name="l00327"></a>00327 <span class="comment">    */</span>
<a name="l00328"></a>00328     <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"The expected event size is "</span>&lt;&lt;<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#58642b3859b45fae4b485c09edbf1d50">GetEventSize</a>()
<a name="l00329"></a>00329                   &lt;&lt;<span class="stringliteral">" bytes."</span>&lt;&lt;std::endl;   
<a name="l00330"></a>00330     <span class="comment">//wait 2 seconds for DC offset levels to adjust</span>
<a name="l00331"></a>00331     time_t now = time(0);
<a name="l00332"></a>00332     <span class="keywordflow">while</span>(time(0) - now &lt; 2) {}
<a name="l00333"></a>00333   }
<a name="l00334"></a>00334   <span class="keywordflow">catch</span>(...){ 
<a name="l00335"></a>00335     <span class="keywordflow">return</span> -3;
<a name="l00336"></a>00336   }
<a name="l00337"></a>00337   <span class="keywordflow">return</span> 0;
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 <span class="comment">//predicate for find_if function used to test if any board has data</span>
<a name="l00341"></a>00341 <span class="keywordtype">bool</span> DataAvailable(uint32_t status)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343   <span class="keywordflow">return</span> (status &amp; 0x8);
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a><a class="code" href="classV172X__Daq.html#04e577ee1fc864f63eeea4b5faee9b38">00346</a> <span class="keywordtype">void</span> <a class="code" href="classV172X__Daq.html#04e577ee1fc864f63eeea4b5faee9b38">V172X_Daq::DataAcquisitionLoop</a>()
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348   <span class="keywordflow">if</span>(!<a class="code" href="classV172X__Daq.html#fbaee15650b78da67e46cbd2ecd91b67">_initialized</a>) <a class="code" href="classV172X__Daq.html#0600101d6215d2c143e7022e55ed44bd">Initialize</a>();
<a name="l00349"></a>00349   <span class="comment">//prepare some variables</span>
<a name="l00350"></a>00350   <a class="code" href="classV172X__Daq.html#92d4e4af281216a4b1818f14f91c408d">_triggers</a> = 0;
<a name="l00351"></a>00351   std::vector&lt;uint32_t&gt; acq_status(<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#efec64903a47b9c984a48cd7bf2f230f">enabled_boards</a>);
<a name="l00352"></a>00352   <span class="comment">//Arm the boards</span>
<a name="l00353"></a>00353   <span class="keywordflow">try</span>{
<a name="l00354"></a>00354     std::vector&lt;uint32_t&gt; acq_write;
<a name="l00355"></a>00355     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#39fce0d8eb0869d8b5c9b8596c9b7700">nboards</a>; i++){
<a name="l00356"></a>00356       <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#66b10413b8e533ee0f879e1a4c4d1198">enabled</a>){
<a name="l00357"></a>00357         acq_write.push_back(<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#aee3121553af3a23717be381d1d167eb">board</a>[i].<a class="code" href="classV172X__BoardParams.html#986c9e16d36e6e453a565bc9538c0fa6">acq_control_val</a>+0x4);
<a name="l00358"></a>00358       }
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360     <a class="code" href="classV172X__Daq.html#ca00440a737534a44b2c3d733e6c503a">WriteVMERegisters</a>(VME_SWClear,1);
<a name="l00361"></a>00361     <a class="code" href="classV172X__Daq.html#ca00440a737534a44b2c3d733e6c503a">WriteVMERegisters</a>(VME_AcquisitionControl,&amp;(acq_write[0]));
<a name="l00362"></a>00362     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#1efb4af16281ff5b5ba4892789f1301a">_params</a>.<a class="code" href="classV172X__Params.html#39778fccabd270f58585798100feca91">send_start_pulse</a>)
<a name="l00363"></a>00363       CAENVME_SetOutputRegister(<a class="code" href="classV172X__Daq.html#1cb7dfe53837ed1cb9686cf70d446e1a">_handle_vme_bridge</a>, 
<a name="l00364"></a>00364                                 cvOut0Bit | cvOut1Bit | cvOut2Bit | 
<a name="l00365"></a>00365                                 cvOut3Bit | cvOut4Bit );
<a name="l00366"></a>00366   }
<a name="l00367"></a>00367   <span class="keywordflow">catch</span>(std::exception&amp; e){
<a name="l00368"></a>00368     <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Unable to arm the board for run!\n"</span>;
<a name="l00369"></a>00369     _initialized=<span class="keyword">false</span>;
<a name="l00370"></a>00370     _status=INIT_FAILURE;
<a name="l00371"></a>00371     <span class="keywordflow">return</span>;
<a name="l00372"></a>00372   }
<a name="l00373"></a>00373   int32_t irq_handle = _handle_vme_bridge;
<a name="l00374"></a>00374   <span class="keywordflow">if</span> (_params.vme_bridge_link) 
<a name="l00375"></a>00375     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; _params.nboards; i++) { 
<a name="l00376"></a>00376       irq_handle = _handle_board[i]; 
<a name="l00377"></a>00377       <span class="keywordflow">if</span> (_params.board[i].enabled &amp;&amp; _params.board[i].link &gt;= 0) <span class="keywordflow">break</span>;
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379   <span class="keywordflow">while</span>(_is_running ){
<a name="l00380"></a>00380     <span class="comment">//DON'T check to see if data is ready, just go to interrupt</span>
<a name="l00381"></a>00381     <span class="comment">//may be slightly slower, but much more stable</span>
<a name="l00382"></a>00382     
<a name="l00383"></a>00383     <span class="comment">//Enable IRQ lines and wait for an interrupt</span>
<a name="l00384"></a>00384     CAENVME_IRQEnable(irq_handle,0xFF);
<a name="l00385"></a>00385     CVErrorCodes err = CAENVME_IRQWait(irq_handle,0xFF,
<a name="l00386"></a>00386                                        _params.trigger_timeout_ms);
<a name="l00387"></a>00387     CAENVME_IRQDisable(irq_handle,0xFF);
<a name="l00388"></a>00388     <span class="comment">//Check to see if there was an interrupt or just the timeout</span>
<a name="l00389"></a>00389     <span class="keywordflow">switch</span>(err){
<a name="l00390"></a>00390     <span class="keywordflow">case</span> cvSuccess:
<a name="l00391"></a>00391       <span class="keywordflow">break</span>;
<a name="l00392"></a>00392     <span class="keywordflow">case</span> cvGenericError:
<a name="l00393"></a>00393       <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Generic error occurred. Probably just a timeout...\n"</span>;
<a name="l00394"></a>00394       <span class="comment">//notice: no break here!</span>
<a name="l00395"></a>00395     <span class="keywordflow">case</span> cvTimeoutError:
<a name="l00396"></a>00396       <span class="keywordflow">if</span>(_params.auto_trigger){
<a name="l00397"></a>00397         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Triggering...\n"</span>;
<a name="l00398"></a>00398         WriteVMERegisters(VME_SWTrigger,1);
<a name="l00399"></a>00399       }
<a name="l00400"></a>00400       <span class="keywordflow">else</span>
<a name="l00401"></a>00401         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Waiting for trigger..."</span>&lt;&lt;std::endl;
<a name="l00402"></a>00402       <span class="keywordflow">continue</span>;
<a name="l00403"></a>00403       <span class="keywordflow">break</span>;
<a name="l00404"></a>00404     <span class="keywordflow">default</span>:
<a name="l00405"></a>00405       <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Unknown error waiting for trigger interrupt\n"</span>;
<a name="l00406"></a>00406       <span class="keywordflow">break</span>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408     
<a name="l00409"></a>00409     <span class="comment">//if we get here, there is an event ready for download</span>
<a name="l00410"></a>00410     <span class="comment">//get a new event ready </span>
<a name="l00411"></a>00411     <a class="code" href="group__daqman.html#g0f82e6cccd71bdffb21c8b72eb91a662">RawEventPtr</a> next_event(<span class="keyword">new</span> <a class="code" href="classRawEvent.html">RawEvent</a>);
<a name="l00412"></a>00412     size_t blocknum = 
<a name="l00413"></a>00413       next_event-&gt;AddDataBlock(RawEvent::CAEN_V172X,
<a name="l00414"></a>00414                                _params.event_size_bytes+event_size_padding);
<a name="l00415"></a>00415     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buffer = next_event-&gt;GetRawDataBlock(blocknum);
<a name="l00416"></a>00416     <span class="keyword">const</span> uint32_t UNSET_EVENT_COUNTER = 0xFFFFFFFF;
<a name="l00417"></a>00417     uint32_t event_counter = UNSET_EVENT_COUNTER;
<a name="l00418"></a>00418     <span class="comment">//get the data</span>
<a name="l00419"></a>00419     <span class="keywordtype">int</span> data_transferred = 0;
<a name="l00420"></a>00420     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;_params.nboards; i++){
<a name="l00421"></a>00421       <span class="keywordflow">if</span>(!_params.board[i].enabled) <span class="keywordflow">continue</span>;
<a name="l00422"></a>00422       <span class="comment">//wait until the event is ready on the board</span>
<a name="l00423"></a>00423       
<a name="l00424"></a>00424       <span class="keywordtype">int</span> tries = 0;
<a name="l00425"></a>00425       <span class="keyword">const</span> <span class="keywordtype">int</span> maxtries = 50;
<a name="l00426"></a>00426       <span class="keywordflow">while</span>(!DataAvailable(ReadVMERegister(_params.board[i].address+
<a name="l00427"></a>00427                                            VME_AcquisitionStatus, _handle_board[i])) &amp;&amp;
<a name="l00428"></a>00428             tries++ &lt; maxtries) {}
<a name="l00429"></a>00429       <span class="keywordflow">if</span>(tries &gt;= maxtries){
<a name="l00430"></a>00430         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"No trigger received on board "</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00431"></a>00431         <span class="keywordflow">continue</span>;
<a name="l00432"></a>00432       }
<a name="l00433"></a>00433       
<a name="l00434"></a>00434       <span class="keywordtype">int</span> this_dl_size = 0;
<a name="l00435"></a>00435       tries=0;
<a name="l00436"></a>00436       CVErrorCodes err = cvSuccess;
<a name="l00437"></a>00437       <span class="keywordflow">while</span>(this_dl_size == 0 &amp;&amp; ++tries&lt;maxtries ){
<a name="l00438"></a>00438         err = 
<a name="l00439"></a>00439           CAENVME_FIFOBLTReadCycle(_handle_board[i], _params.board[i].address,
<a name="l00440"></a>00440                                    buffer + data_transferred,
<a name="l00441"></a>00441                                    _params.board[i].event_size_bytes,
<a name="l00442"></a>00442                                    cvA32_U_MBLT, cvD64, &amp;this_dl_size);
<a name="l00443"></a>00443         <span class="keywordflow">if</span>(err != cvSuccess &amp;&amp; err != cvBusError){
<a name="l00444"></a>00444           <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Error generated while downloading event from board"</span>
<a name="l00445"></a>00445                         &lt;&lt;i&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;CAENVME_DecodeError(err)&lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00446"></a>00446           <span class="keywordflow">continue</span>;
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448       }
<a name="l00449"></a>00449       
<a name="l00450"></a>00450       <span class="keywordflow">if</span>(this_dl_size&lt;=0){
<a name="l00451"></a>00451         <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"0 bytes downloaded for board "</span>&lt;&lt;i&lt;&lt;std::endl;
<a name="l00452"></a>00452         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Events stored on this board: "</span>
<a name="l00453"></a>00453                       &lt;&lt;ReadVMERegister(_params.board[i].address+
<a name="l00454"></a>00454                                         VME_EventsStored, _handle_board[i])&lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00455"></a>00455         uint32_t out;
<a name="l00456"></a>00456         out = ReadVMERegister(_params.board[i].address+VME_VMEStatus, 
<a name="l00457"></a>00457                               _handle_board[i]);
<a name="l00458"></a>00458         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"VME status:"</span>
<a name="l00459"></a>00459                       &lt;&lt;<span class="stringliteral">"\n\tBERR flag: "</span>&lt;&lt; (out&amp;4)
<a name="l00460"></a>00460                       &lt;&lt;<span class="stringliteral">"\n\tOutput buffer full: "</span>&lt;&lt; (out&amp;2)
<a name="l00461"></a>00461                       &lt;&lt;<span class="stringliteral">"\n\tData ready: "</span>&lt;&lt; (out&amp;1)&lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00462"></a>00462         out = ReadVMERegister(_params.board[i].address+VME_AcquisitionStatus, 
<a name="l00463"></a>00463                               _handle_board[i]);
<a name="l00464"></a>00464         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Acquisition status:"</span>
<a name="l00465"></a>00465                       &lt;&lt;<span class="stringliteral">"\n\tReady for acquisition: "</span>&lt;&lt; (out&amp;256)
<a name="l00466"></a>00466                       &lt;&lt;<span class="stringliteral">"\n\tPLL Status: "</span>&lt;&lt; (out&amp;128)
<a name="l00467"></a>00467                       &lt;&lt;<span class="stringliteral">"\n\tPLL Bypass: "</span>&lt;&lt; (out&amp;64)
<a name="l00468"></a>00468                       &lt;&lt;<span class="stringliteral">"\n\tClock source: "</span>&lt;&lt; (out&amp;32)
<a name="l00469"></a>00469                       &lt;&lt;<span class="stringliteral">"\n\tEvents full: "</span>&lt;&lt; (out&amp;16)
<a name="l00470"></a>00470                       &lt;&lt;<span class="stringliteral">"\n\tEvent ready: "</span>&lt;&lt; (out&amp;8)
<a name="l00471"></a>00471                       &lt;&lt;<span class="stringliteral">"\n\t Run on: "</span>&lt;&lt; (out&amp;4) &lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00472"></a>00472         out = ReadVMERegister(_params.board[i].address+VME_EventSize, 
<a name="l00473"></a>00473                               _handle_board[i]);
<a name="l00474"></a>00474         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Next event size: "</span>&lt;&lt;out&lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00475"></a>00475         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Expected event size "</span>
<a name="l00476"></a>00476                       &lt;&lt;_params.board[i].event_size_bytes/4&lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00477"></a>00477         
<a name="l00478"></a>00478         
<a name="l00479"></a>00479         <span class="comment">//free the buffer so we don't re-trigger spuriously</span>
<a name="l00480"></a>00480         WriteVMERegister(_params.board[i].address+VME_BufferFree,1, 
<a name="l00481"></a>00481                          _handle_board[i]);
<a name="l00482"></a>00482         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Events stored on this board: "</span>
<a name="l00483"></a>00483                       &lt;&lt;ReadVMERegister(_params.board[i].address+
<a name="l00484"></a>00484                                         VME_EventsStored, _handle_board[i])
<a name="l00485"></a>00485                       &lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00486"></a>00486         WriteVMERegister(_params.board[i].address+VME_BufferFree,2, 
<a name="l00487"></a>00487                          _handle_board[i]);
<a name="l00488"></a>00488         <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">"Events stored on this board: "</span>
<a name="l00489"></a>00489                       &lt;&lt;ReadVMERegister(_params.board[i].address+
<a name="l00490"></a>00490                                         VME_EventsStored, _handle_board[i])
<a name="l00491"></a>00491                       &lt;&lt;<span class="stringliteral">"\n"</span>;
<a name="l00492"></a>00492         <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Boards don't usually recover from this error! "</span>
<a name="l00493"></a>00493                       &lt;&lt;<span class="stringliteral">"Aborting!\n"</span>;
<a name="l00494"></a>00494         _status = COMM_ERROR;
<a name="l00495"></a>00495         _is_running = <span class="keyword">false</span>;
<a name="l00496"></a>00496         <span class="keywordflow">break</span>;
<a name="l00497"></a>00497       }
<a name="l00498"></a>00498       <span class="keywordflow">else</span>{
<a name="l00499"></a>00499         
<a name="l00500"></a>00500         <span class="comment">//this could ignore potential align64 extra bits:</span>
<a name="l00501"></a>00501         <span class="comment">//data_transferred += this_dl_size;</span>
<a name="l00502"></a>00502         <span class="comment">//instead, we check the actual event</span>
<a name="l00503"></a>00503         <span class="keywordtype">long</span> ev_size = (*((uint32_t*)(buffer+data_transferred)) &amp; 
<a name="l00504"></a>00504                              0x0FFFFFFF) * <span class="keyword">sizeof</span>(uint32_t);
<a name="l00505"></a>00505         <span class="keywordflow">if</span>(std::abs(ev_size - this_dl_size) &gt; 5){
<a name="l00506"></a>00506           <a class="code" href="classMessage.html">Message</a>(WARNING)&lt;&lt;<span class="stringliteral">"Event size does not match download count!\n\t"</span>
<a name="l00507"></a>00507                           &lt;&lt;<span class="stringliteral">"Event size: "</span>&lt;&lt;ev_size&lt;&lt;<span class="stringliteral">"; download size: "</span>
<a name="l00508"></a>00508                           &lt;&lt;this_dl_size&lt;&lt;<span class="stringliteral">"; requested download "</span>
<a name="l00509"></a>00509                           &lt;&lt;_params.board[i].event_size_bytes&lt;&lt;std::endl;
<a name="l00510"></a>00510           <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"Boards don't usually recover from this error! "</span>
<a name="l00511"></a>00511                       &lt;&lt;<span class="stringliteral">"Aborting!\n"</span>;
<a name="l00512"></a>00512           _status = COMM_ERROR;
<a name="l00513"></a>00513           _is_running = <span class="keyword">false</span>;
<a name="l00514"></a>00514           <span class="keywordflow">break</span>;
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516         <span class="comment">//check for event ID misalignment</span>
<a name="l00517"></a>00517         uint32_t evct = (((uint32_t*)(buffer+data_transferred))[2])&amp;0xFFFFFF;
<a name="l00518"></a>00518         <span class="keywordflow">if</span>(event_counter == UNSET_EVENT_COUNTER)
<a name="l00519"></a>00519           event_counter = evct;
<a name="l00520"></a>00520         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(evct != event_counter){
<a name="l00521"></a>00521           <a class="code" href="classMessage.html">Message</a>(CRITICAL)&lt;&lt;<span class="stringliteral">"Mismatched event ID on board "</span>&lt;&lt;i
<a name="l00522"></a>00522                            &lt;&lt;<span class="stringliteral">"; received "</span>&lt;&lt;evct&lt;&lt;<span class="stringliteral">", expected "</span>&lt;&lt;event_counter
<a name="l00523"></a>00523                            &lt;&lt;<span class="stringliteral">"; Aboring run\n"</span>;
<a name="l00524"></a>00524           _status = GENERIC_ERROR;
<a name="l00525"></a>00525           _is_running=<span class="keyword">false</span>;
<a name="l00526"></a>00526           <span class="keywordflow">break</span>;
<a name="l00527"></a>00527         }
<a name="l00528"></a>00528       
<a name="l00529"></a>00529         data_transferred += ev_size;
<a name="l00530"></a>00530         
<a name="l00531"></a>00531       }
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533     <span class="keywordflow">if</span>(GetStatus() != NORMAL){
<a name="l00534"></a>00534       _is_running = <span class="keyword">false</span>;
<a name="l00535"></a>00535       <span class="keywordflow">break</span>;
<a name="l00536"></a>00536     }
<a name="l00537"></a>00537     <span class="keywordflow">if</span>(data_transferred &lt;= 0){
<a name="l00538"></a>00538       <a class="code" href="classMessage.html">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">"No boards transferred usable data this event!\n"</span>;
<a name="l00539"></a>00539       <span class="keywordflow">continue</span>;
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541     <span class="keywordflow">else</span>{
<a name="l00542"></a>00542       _triggers++;
<a name="l00543"></a>00543       next_event-&gt;SetDataBlockSize(blocknum, data_transferred);
<a name="l00544"></a>00544       PostEvent(next_event);
<a name="l00545"></a>00545     }    
<a name="l00546"></a>00546   }<span class="comment">//end while(_is_running)</span>
<a name="l00547"></a>00547    <span class="comment">//We only reach here once the event has stopped, so clean up any mess</span>
<a name="l00548"></a>00548   <span class="comment">//First, end the run, and clear the buffers</span>
<a name="l00549"></a>00549   <span class="keywordflow">if</span>(_params.send_start_pulse)
<a name="l00550"></a>00550     CAENVME_ClearOutputRegister(_handle_vme_bridge, 0xFFFF);
<a name="l00551"></a>00551   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;_params.nboards; i++){
<a name="l00552"></a>00552     <span class="keywordflow">if</span>(_params.board[i].enabled){
<a name="l00553"></a>00553       WriteVMERegister(_params.board[i].address+ VME_AcquisitionControl,
<a name="l00554"></a>00554                        _params.board[i].acq_control_val, _handle_board[i]);
<a name="l00555"></a>00555       WriteVMERegister(_params.board[i].address+VME_SWClear,0x1, _handle_board[i]);
<a name="l00556"></a>00556     }
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558   WriteVMERegisters(VME_SWReset,1);
<a name="l00559"></a>00559   <a class="code" href="classMessage.html">Message</a>(DEBUG)&lt;&lt;_triggers&lt;&lt;<span class="stringliteral">" total triggers downloaded."</span>&lt;&lt;std::endl;
<a name="l00560"></a>00560 }  
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 25 13:42:36 2013 for daqman by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
