<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>daqman: daq/src/V172X_Daq.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_94b1b7b36dd0a4cc60043900d5b3f141.html">daq</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_2f7e6dc45b4a03bf1a468437f03c051c.html">src</a>
  </div>
</div>
<div class="contents">
<h1>V172X_Daq.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* --------------------------------------------------------</span>
<a name="l00002"></a>00002 <span class="comment">CAEN_V172XDAQ.cc</span>
<a name="l00003"></a>00003 <span class="comment">This is the implementation for the CAEN_V172XDAQ class, </span>
<a name="l00004"></a>00004 <span class="comment">which inherits from the WARP_VetoDAQ class.</span>
<a name="l00005"></a>00005 <span class="comment">----------------------------------------------------------*/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;<a class="code" href="V172X__Daq_8hh.html" title="Defines V172X_Daq class which interfaces with CAEN V172X digitizers.">V172X_Daq.hh</a>&quot;</span>
<a name="l00008"></a>00008 <span class="comment">//#include &quot;CAEN_V172XEvent.hh&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;CAENVMElib.h&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="RawEvent_8hh.html" title="Defines the RawEvent class which wrawp raw data and RawEventPtr.">RawEvent.hh</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="Message_8hh.html" title="Definition for Message class.">Message.hh</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="ConfigHandler_8hh.html" title="Defines the ConfigHandler global configuration class.">ConfigHandler.hh</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="EventHandler_8hh.html" title="Defines the EventHandler module controller.">EventHandler.hh</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;bitset&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;boost/ref.hpp&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;boost/timer.hpp&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;boost/date_time/posix_time/posix_time_duration.hpp&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">//declare some useful constants</span>
<a name="l00024"></a>00024 <span class="keyword">const</span> <span class="keywordtype">int</span> event_size_padding = 8;
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="keyword">enum</span> VME_REGISTERS{
<a name="l00027"></a>00027   VME_ChZSThresh =         0x1024,
<a name="l00028"></a>00028   VME_ChZSNsamples =       0x1028,
<a name="l00029"></a>00029   VME_ChTrigThresh =       0x1080,
<a name="l00030"></a>00030   VME_ChTrigSamples =      0x1084,
<a name="l00031"></a>00031   VME_ChStatus =           0x1088,
<a name="l00032"></a>00032   VME_ChBuffersFull =      0x1094,
<a name="l00033"></a>00033   VME_ChDAC =              0x1098,
<a name="l00034"></a>00034   VME_ChannelsConfig =     0x8000,
<a name="l00035"></a>00035   VME_BufferCode =         0x800C,
<a name="l00036"></a>00036   VME_BufferFree =         0x8010,
<a name="l00037"></a>00037   VME_CustomSize =         0x8020,
<a name="l00038"></a>00038   VME_AcquisitionControl = 0x8100,
<a name="l00039"></a>00039   VME_AcquisitionStatus =  0x8104,
<a name="l00040"></a>00040   VME_SWTrigger =          0x8108,
<a name="l00041"></a>00041   VME_TrigSourceMask =     0x810C,
<a name="l00042"></a>00042   VME_TrigOutMask =        0x8110,
<a name="l00043"></a>00043   VME_PostTriggerSetting = 0x8114,
<a name="l00044"></a>00044   VME_FrontPanelIO =       0x811C,
<a name="l00045"></a>00045   VME_ChannelMask =        0x8120,
<a name="l00046"></a>00046   VME_DownsampleFactor =   0x8128,
<a name="l00047"></a>00047   VME_EventsStored =       0x812C,
<a name="l00048"></a>00048   VME_BoardInfo =          0x8140,
<a name="l00049"></a>00049   VME_EventSize =          0x814C,
<a name="l00050"></a>00050   VME_VMEControl =         0xEF00,
<a name="l00051"></a>00051   VME_VMEStatus =          0xEF04,
<a name="l00052"></a>00052   VME_BoardID =            0xEF08,
<a name="l00053"></a>00053   VME_RelocationAddress =  0xEF10,
<a name="l00054"></a>00054   VME_InterruptID =        0xEF14,
<a name="l00055"></a>00055   VME_InterruptOnEvent =   0xEF18,
<a name="l00056"></a>00056   VME_BLTEvents =          0xEF1C,
<a name="l00057"></a>00057   VME_SWReset =            0xEF24,
<a name="l00058"></a>00058   VME_SWClear =            0xEF28,
<a name="l00059"></a>00059 };
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="classV172X__Daq.html#affd654241f8ba6beabd6ec037ed39d1a">00061</a> <a class="code" href="classV172X__Daq.html#affd654241f8ba6beabd6ec037ed39d1a" title="Default constructor.">V172X_Daq::V172X_Daq</a>() : <a class="code" href="classBaseDaq.html" title="Abstract class to define a DAQ hardware interface.">BaseDaq</a>(), _initialized(false), 
<a name="l00062"></a>00062                          _params(), _triggers(0), _vme_mutex()
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <a class="code" href="classConfigHandler.html#aa014f0691bfd8b19256b14796e8f2610" title="Get the global singleton pointer - only way to construct.">ConfigHandler::GetInstance</a>()-&gt;<a class="code" href="classParameterList.html#a3db08300f6dfab45123dd4e2db712d89" title="Register a new subparameter.">RegisterParameter</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classVParameterNode.html#ad84847c0c43b2feca44840c8f6346df7" title="Get the default name of this parameter.">GetDefaultKey</a>(),
<a name="l00065"></a>00065                                                   <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>);
<a name="l00066"></a>00066   <a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a> = 0;
<a name="l00067"></a>00067   std::fill (<a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a> + <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>, 0);
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="classV172X__Daq.html#acb1847daf8edea1ca20d7f5f8ef29bc4">00070</a> <a class="code" href="classV172X__Daq.html#acb1847daf8edea1ca20d7f5f8ef29bc4" title="Destructor.">V172X_Daq::~V172X_Daq</a>()
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072   <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a> &gt;= 0) CAENVME_End(<a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++)
<a name="l00075"></a>00075     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a> &amp;&amp; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a> &gt; 0 &amp;&amp; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a> != <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a>) CAENVME_End(<a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="keywordtype">int</span> init_link (<span class="keywordtype">int</span> link, <span class="keywordtype">int</span> board, <span class="keywordtype">bool</span> usb, int32_t *handle) {
<a name="l00079"></a>00079   CVErrorCodes err = CAENVME_Init(usb ? cvV1718 : cvV2718, link, board, handle);
<a name="l00080"></a>00080   <span class="keywordflow">if</span>(err != cvSuccess){
<a name="l00081"></a>00081     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a> m(ERROR);
<a name="l00082"></a>00082     m&lt;&lt;<span class="stringliteral">&quot;Unable to initialize CAEN VME bridge for link &quot;</span> &lt;&lt; link;
<a name="l00083"></a>00083     <span class="keywordflow">if</span>(usb) m&lt;&lt;<span class="stringliteral">&quot; on USB &quot;</span>;
<a name="l00084"></a>00084     m&lt;&lt; <span class="stringliteral">&quot;: &quot;</span>&lt;&lt;std::endl;
<a name="l00085"></a>00085     m&lt;&lt;<span class="stringliteral">&quot;\t&quot;</span>&lt;&lt;CAENVME_DecodeError(err)&lt;&lt;std::endl;
<a name="l00086"></a>00086     <span class="keywordflow">return</span> -1;
<a name="l00087"></a>00087   }
<a name="l00088"></a>00088   <span class="keywordtype">char</span> message[100];
<a name="l00089"></a>00089   <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;CAEN VME bridge successfully initialized for link &quot;</span> 
<a name="l00090"></a>00090                 &lt;&lt; link &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt;std::endl;
<a name="l00091"></a>00091   CAENVME_BoardFWRelease(*handle,message);
<a name="l00092"></a>00092   <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;\tFirmware Release: &quot;</span>&lt;&lt;message&lt;&lt;std::endl;
<a name="l00093"></a>00093   CAENVME_DriverRelease(*handle,message);
<a name="l00094"></a>00094   <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;\tDriver Release: &quot;</span>&lt;&lt;message&lt;&lt;std::endl;
<a name="l00095"></a>00095   <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(INFO)&lt;&lt; <span class="stringliteral">&quot;Link &quot;</span> &lt;&lt; link &lt;&lt; <span class="stringliteral">&quot; initialized on handle &quot;</span> 
<a name="l00096"></a>00096                &lt;&lt; *handle &lt;&lt;std::endl;
<a name="l00097"></a>00097   <span class="keywordflow">return</span> 0;
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="classV172X__Daq.html#a0600101d6215d2c143e7022e55ed44bd">00101</a> <span class="keywordtype">int</span> <a class="code" href="classV172X__Daq.html#a0600101d6215d2c143e7022e55ed44bd" title="Initialize the hardware communication.">V172X_Daq::Initialize</a>()
<a name="l00102"></a>00102 {
<a name="l00103"></a>00103   <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#afbaee15650b78da67e46cbd2ecd91b67" title="Is hardware initialized?">_initialized</a>){
<a name="l00104"></a>00104     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(WARNING)&lt;&lt;<span class="stringliteral">&quot;Reinitializing V172X_Daq...&quot;</span>&lt;&lt;std::endl;
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a> &gt;= 0) CAENVME_End(<a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++)
<a name="l00108"></a>00108       <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a> &amp;&amp; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a> &gt; 0 &amp;&amp; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a> != <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a>) CAENVME_End(<a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00109"></a>00109   }
<a name="l00110"></a>00110       
<a name="l00111"></a>00111   <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a> &gt;= 0) {
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (init_link (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a>, 0, <span class="keyword">false</span>, &amp;<a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>) &lt; 0){
<a name="l00113"></a>00113       <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a>=<a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aa5d0fd9dfb083002684f010497c2122f3" title="enum value: Initialization Failure">INIT_FAILURE</a>;
<a name="l00114"></a>00114       <span class="keywordflow">return</span> -1;
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116     <span class="comment">//reset everything</span>
<a name="l00117"></a>00117     <span class="comment">//CAENVME_SystemReset(_handle_vme_bridge);</span>
<a name="l00118"></a>00118     <span class="comment">//CAENVME_DeviceReset(_handle_vme_bridge);</span>
<a name="l00119"></a>00119     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39778fccabd270f58585798100feca91" title="synchronize start of run on all boards?">send_start_pulse</a>) {
<a name="l00120"></a>00120       CAENVME_ClearOutputRegister(<a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>, 0xFFFF);
<a name="l00121"></a>00121       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> line = 0; line&lt;5; line++){
<a name="l00122"></a>00122         CVErrorCodes err = CAENVME_SetOutputConf(<a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>, (CVOutputSelect)line, cvDirect, 
<a name="l00123"></a>00123             cvActiveHigh, cvManualSW);
<a name="l00124"></a>00124         <span class="keywordflow">if</span>(err != cvSuccess){
<a name="l00125"></a>00125           <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Unable to configure the V2718 output registers.\n&quot;</span>;
<a name="l00126"></a>00126           <span class="keywordflow">return</span> -2;
<a name="l00127"></a>00127         }
<a name="l00128"></a>00128       }
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130   } 
<a name="l00131"></a>00131   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39778fccabd270f58585798100feca91" title="synchronize start of run on all boards?">send_start_pulse</a>) {
<a name="l00132"></a>00132     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(WARNING)&lt;&lt;<span class="stringliteral">&quot;send_start_pulse enabled but no bridge link present, disabling pulses&quot;</span> &lt;&lt; std::endl;
<a name="l00133"></a>00133     <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39778fccabd270f58585798100feca91" title="synchronize start of run on all boards?">send_start_pulse</a> = 0;
<a name="l00134"></a>00134   }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++) {
<a name="l00137"></a>00137     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a> &amp;&amp; 
<a name="l00138"></a>00138        ( ( <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a> &gt;= 0 &amp;&amp; 
<a name="l00139"></a>00139          <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a> != <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a> )
<a name="l00140"></a>00140          || <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a517967a27b836c97e03ff749b19c0bb2" title="connect through usb instead of optical link?">usb</a> ) ){
<a name="l00141"></a>00141       <span class="keywordflow">if</span> (init_link (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a>, <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#aad9cb77de30367d1518d594f8a3a005d" title="Order of the board on a daisy chain fiber.">chainindex</a>, 
<a name="l00142"></a>00142                      <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a517967a27b836c97e03ff749b19c0bb2" title="connect through usb instead of optical link?">usb</a>, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a> + i) &lt; 0) {
<a name="l00143"></a>00143         <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a>=<a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aa5d0fd9dfb083002684f010497c2122f3" title="enum value: Initialization Failure">INIT_FAILURE</a>;
<a name="l00144"></a>00144         <span class="keywordflow">return</span> -3;
<a name="l00145"></a>00145       }
<a name="l00146"></a>00146     } 
<a name="l00147"></a>00147     <span class="keywordflow">else</span> <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i] = <a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>;
<a name="l00148"></a>00148   }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++){
<a name="l00151"></a>00151     <span class="comment">//Initialize each enabled board</span>
<a name="l00152"></a>00152     <span class="keywordflow">if</span>(!<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a>) 
<a name="l00153"></a>00153       <span class="keywordflow">continue</span>;
<a name="l00154"></a>00154     <span class="keywordflow">try</span>{
<a name="l00155"></a>00155       <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a632f58ec4f155f9732134f9fd2bcd2c8" title="Initialize parameters for a single board.">InitializeBoard</a>(i)){
<a name="l00156"></a>00156         <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a> = <a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aa5d0fd9dfb083002684f010497c2122f3" title="enum value: Initialization Failure">INIT_FAILURE</a>;
<a name="l00157"></a>00157         <span class="keywordflow">return</span> -5;
<a name="l00158"></a>00158       }
<a name="l00159"></a>00159       
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161     <span class="keywordflow">catch</span>(std::exception &amp;error)
<a name="l00162"></a>00162       {
<a name="l00163"></a>00163         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(EXCEPTION)&lt;&lt;error.what()&lt;&lt;std::endl;
<a name="l00164"></a>00164         <span class="keywordflow">return</span> -6;
<a name="l00165"></a>00165       }
<a name="l00166"></a>00166   }
<a name="l00167"></a>00167   <a class="code" href="classV172X__Daq.html#afbaee15650b78da67e46cbd2ecd91b67" title="Is hardware initialized?">_initialized</a> = <span class="keyword">true</span>;
<a name="l00168"></a>00168   <span class="keywordflow">return</span> <a class="code" href="classV172X__Daq.html#a415f5bb68331689e007c9801073cd943" title="Update the hardware parameters.">Update</a>();
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="classV172X__Daq.html#a632f58ec4f155f9732134f9fd2bcd2c8">00171</a> <span class="keywordtype">int</span> <a class="code" href="classV172X__Daq.html#a632f58ec4f155f9732134f9fd2bcd2c8" title="Initialize parameters for a single board.">V172X_Daq::InitializeBoard</a>(<span class="keywordtype">int</span> boardnum)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173   <a class="code" href="classV172X__BoardParams.html" title="parameter list for each V172X digitizer in the crate">V172X_BoardParams</a>&amp; board = <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[boardnum];
<a name="l00174"></a>00174   <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a> + VME_SWReset, 1, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[boardnum]);
<a name="l00175"></a>00175   uint32_t data = <a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_BoardInfo, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[boardnum]);
<a name="l00176"></a>00176   board.<a class="code" href="classV172X__BoardParams.html#a153220c43c585f937cec14cd080d81e3" title="type of V172X digitizer">board_type</a> = (<a class="code" href="group__daqman.html#ga6423298fc4fa51a1962a0c26b3baa2a1" title="defines the available models of V172X digitzer">BOARD_TYPE</a>)(data&amp;0xFF);
<a name="l00177"></a>00177   board.<a class="code" href="classV172X__BoardParams.html#af35d03605a5890b8e4fe3ce93142f645" title="actual num channels on this unit">nchans</a> = (data&gt;&gt;16)&amp;0xFF;
<a name="l00178"></a>00178   board.<a class="code" href="classV172X__BoardParams.html#aa83fdc64ebcbc39b0de854ac8f04d4d2" title="mem size per channel, in bytes">mem_size</a> = (data&gt;&gt;8)&amp;0xFF;
<a name="l00179"></a>00179   <span class="keywordflow">if</span>(board.<a class="code" href="classV172X__BoardParams.html#a55773357f01342a8b00ea0ef5b7e050e" title="Update calcuated variables after changing parameters.">UpdateBoardSpecificVariables</a>()){ <span class="comment">//returns -1 on error</span>
<a name="l00180"></a>00180     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(CRITICAL)&lt;&lt;<span class="stringliteral">&quot;Board &quot;</span>&lt;&lt;boardnum&lt;&lt;<span class="stringliteral">&quot; with address &quot;</span>
<a name="l00181"></a>00181                      &lt;&lt;std::hex&lt;&lt;std::showbase
<a name="l00182"></a>00182                      &lt;&lt;board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>&lt;&lt;std::dec&lt;&lt;std::noshowbase
<a name="l00183"></a>00183                      &lt;&lt;<span class="stringliteral">&quot; is not a V172X digitizer!&quot;</span>&lt;&lt;std::endl;
<a name="l00184"></a>00184     <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a> = <a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aa5d0fd9dfb083002684f010497c2122f3" title="enum value: Initialization Failure">INIT_FAILURE</a>;
<a name="l00185"></a>00185     <span class="keywordflow">return</span> -2;
<a name="l00186"></a>00186   }
<a name="l00187"></a>00187   <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_BoardID,
<a name="l00188"></a>00188                    board.<a class="code" href="classV172X__BoardParams.html#a401f8f5645ab09bffafa861bd0910efd" title="unique id number for this board">id</a>, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[boardnum]);
<a name="l00189"></a>00189   <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_InterruptID,
<a name="l00190"></a>00190                    board.<a class="code" href="classV172X__BoardParams.html#a401f8f5645ab09bffafa861bd0910efd" title="unique id number for this board">id</a>, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[boardnum]);
<a name="l00191"></a>00191   <span class="keywordflow">return</span> 0;
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00194"></a><a class="code" href="classV172X__Daq.html#a415f5bb68331689e007c9801073cd943">00194</a> <span class="keywordtype">int</span> <a class="code" href="classV172X__Daq.html#a415f5bb68331689e007c9801073cd943" title="Update the hardware parameters.">V172X_Daq::Update</a>()
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196   <span class="keywordflow">if</span>(!<a class="code" href="classV172X__Daq.html#afbaee15650b78da67e46cbd2ecd91b67" title="Is hardware initialized?">_initialized</a>){
<a name="l00197"></a>00197     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Attempt to update parameters before initializations!&quot;</span>
<a name="l00198"></a>00198                   &lt;&lt;std::endl;
<a name="l00199"></a>00199     <span class="keywordflow">return</span> -1;
<a name="l00200"></a>00200   }
<a name="l00201"></a>00201   <span class="keywordflow">if</span>(<a class="code" href="classBaseDaq.html#a2a3eb7573c21e7107a48fd91fee64253" title="is the daq running?">_is_running</a>){
<a name="l00202"></a>00202     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Attempt to update parameters while in run.&quot;</span>
<a name="l00203"></a>00203                   &lt;&lt;std::endl;
<a name="l00204"></a>00204     <span class="keywordflow">return</span> -2;
<a name="l00205"></a>00205   }
<a name="l00206"></a>00206   <span class="keywordflow">try</span>{
<a name="l00207"></a>00207     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iboard=0; iboard &lt; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; iboard++){
<a name="l00208"></a>00208       <a class="code" href="classV172X__BoardParams.html" title="parameter list for each V172X digitizer in the crate">V172X_BoardParams</a>&amp; board = <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[iboard];
<a name="l00209"></a>00209       <span class="comment">//downsample factor is not implemented in modern firmware</span>
<a name="l00210"></a>00210       board.<a class="code" href="classV172X__BoardParams.html#a03e80c12cc870afaf0186fedc2b7ef1d" title="NOT USED; kept for compaitibility.">downsample_factor</a>=1; 
<a name="l00211"></a>00211       <span class="keywordflow">if</span>(!board.<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a>) 
<a name="l00212"></a>00212         <span class="keywordflow">continue</span>;
<a name="l00213"></a>00213       <span class="comment">//determine the trigger acquisition window for the database</span>
<a name="l00214"></a>00214       <span class="comment">//WARNING: Assumes it is the same for all boards!!!</span>
<a name="l00215"></a>00215       <a class="code" href="classruninfo.html" title="Contains default and user-specified metadata about each run acquired.">runinfo</a>* info = <a class="code" href="classEventHandler.html#a82a06f8d55b44d8d163b6473ea07f1a8" title="Get the global singleton pointer.">EventHandler::GetInstance</a>()-&gt;<a class="code" href="classEventHandler.html#a58683ac9a2ae8d1e22c76665c32d945c" title="Get the database info about the run.">GetRunInfo</a>();
<a name="l00216"></a>00216       <span class="keywordflow">if</span>(info){
<a name="l00217"></a>00217         std::stringstream ss;
<a name="l00218"></a>00218         ss&lt;&lt;<span class="stringliteral">&quot;board&quot;</span>&lt;&lt;iboard&lt;&lt;<span class="stringliteral">&quot;.pre_trigger_time_us&quot;</span>;
<a name="l00219"></a>00219         info-&gt;<a class="code" href="classruninfo.html#a9c4d82db1ef91b95856da7bebf815584" title="Explicitly set metadata.">SetMetadata</a>(ss.str(), board.<a class="code" href="classV172X__BoardParams.html#ad8cf34d0d043fc193004c9f03d11d91e" title="pulse length to store before trigger">pre_trigger_time_us</a>);
<a name="l00220"></a>00220         ss.str(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00221"></a>00221         ss&lt;&lt;<span class="stringliteral">&quot;board&quot;</span>&lt;&lt;iboard&lt;&lt;<span class="stringliteral">&quot;.post_trigger_time_us&quot;</span>;
<a name="l00222"></a>00222         info-&gt;<a class="code" href="classruninfo.html#a9c4d82db1ef91b95856da7bebf815584" title="Explicitly set metadata.">SetMetadata</a>(ss.str(), board.<a class="code" href="classV172X__BoardParams.html#ab5e84d5b0082b50822ebc86b11154836" title="pulse length to store after trigger">post_trigger_time_us</a>);
<a name="l00223"></a>00223         
<a name="l00224"></a>00224       }
<a name="l00225"></a>00225        
<a name="l00226"></a>00226       uint32_t channel_mask = 0;
<a name="l00227"></a>00227       uint32_t trigger_mask = 0;
<a name="l00228"></a>00228       uint32_t trigger_out_mask = 0;
<a name="l00229"></a>00229       <span class="comment">//need to know total_nsamps to estimate event size</span>
<a name="l00230"></a>00230       <span class="comment">//do the per-channel stuff</span>
<a name="l00231"></a>00231       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;board.<a class="code" href="classV172X__BoardParams.html#af35d03605a5890b8e4fe3ce93142f645" title="actual num channels on this unit">nchans</a>; i++){
<a name="l00232"></a>00232         <a class="code" href="classV172X__ChannelParams.html" title="parameter list for each channel on a V172X digitizer">V172X_ChannelParams</a>&amp; channel = board.<a class="code" href="classV172X__BoardParams.html#ae631288ab0b78ec3ac3e54afda68b15d" title="parameters for each channel">channel</a>[i];
<a name="l00233"></a>00233         channel_mask += (1&lt;&lt;i) * channel.<a class="code" href="classV172X__ChannelParams.html#a15388de4aee725bee8f317a41938fe6c" title="is this channel enabled?">enabled</a>;
<a name="l00234"></a>00234         trigger_mask += (1&lt;&lt;i) * channel.<a class="code" href="classV172X__ChannelParams.html#a8b7059379931dfac750d1f62599679bb" title="can this channel trigger this board?">enable_trigger_source</a>;
<a name="l00235"></a>00235         trigger_out_mask += (1&lt;&lt;i) * channel.<a class="code" href="classV172X__ChannelParams.html#acfacd547521c018f59324d309ce1b648" title="can this channel generate triggers?">enable_trigger_out</a>;
<a name="l00236"></a>00236         <span class="comment">//write the per-channel stuff</span>
<a name="l00237"></a>00237         <span class="comment">//Zero suppression threshold</span>
<a name="l00238"></a>00238         uint32_t zs_thresh = (1&lt;&lt;31) * channel.<a class="code" href="classV172X__ChannelParams.html#ab2fb03b7403e63600167bf0d765e83da" title="polarity for zero suppression threshold">zs_polarity</a> +
<a name="l00239"></a>00239           channel.<a class="code" href="classV172X__ChannelParams.html#ad5cfb620a24f7a54d0c36a0200b0e37e" title="zero suppression level in counts">zs_threshold</a>;
<a name="l00240"></a>00240         <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_ChZSThresh+i*0x100,zs_thresh, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00241"></a>00241         <span class="comment">//zero suppression time over threshold</span>
<a name="l00242"></a>00242         uint32_t nsamp = channel.<a class="code" href="classV172X__ChannelParams.html#ae9be10e7a465c326ad9c619e8a7a77ea" title="time signal must be above zs threshold">zs_thresh_time_us</a> * board.<a class="code" href="classV172X__BoardParams.html#afad0deefe7bd788595029bb3090e4dc6" title="Get the sample rate used, in samples per microsecond.">GetSampleRate</a>();
<a name="l00243"></a>00243         <span class="keywordflow">if</span>(nsamp &gt;= (1&lt;&lt;20)) nsamp = (1&lt;&lt;20) -1;
<a name="l00244"></a>00244         <span class="keywordflow">if</span>(board.<a class="code" href="classV172X__BoardParams.html#a3c540f3a5a6b35cca846738143c5ad41" title="do any zero suppression?">zs_type</a> == ZLE){
<a name="l00245"></a>00245           <span class="comment">//nsamp contains the pre and post samples</span>
<a name="l00246"></a>00246           <span class="keywordflow">if</span>(channel.<a class="code" href="classV172X__ChannelParams.html#a17371e42dd5b945758d9f217df519a7a" title="number of samples to save before zle block">zs_pre_samps</a>&gt;=(1&lt;&lt;16)) channel.<a class="code" href="classV172X__ChannelParams.html#a17371e42dd5b945758d9f217df519a7a" title="number of samples to save before zle block">zs_pre_samps</a> = (1&lt;&lt;16)-1;
<a name="l00247"></a>00247           <span class="keywordflow">if</span>(channel.<a class="code" href="classV172X__ChannelParams.html#ad350062dc4756305df201dbd2a6b9276" title="number of samples to save after ZLE block">zs_post_samps</a>&gt;=(1&lt;&lt;16)) channel.<a class="code" href="classV172X__ChannelParams.html#ad350062dc4756305df201dbd2a6b9276" title="number of samples to save after ZLE block">zs_post_samps</a> = (1&lt;&lt;16)-1;
<a name="l00248"></a>00248           uint32_t npre = 
<a name="l00249"></a>00249             std::ceil(channel.<a class="code" href="classV172X__ChannelParams.html#a17371e42dd5b945758d9f217df519a7a" title="number of samples to save before zle block">zs_pre_samps</a>/board.<a class="code" href="classV172X__BoardParams.html#a1149113e2bad5aec06252fda10669209" title="determines packing of samples in mem">stupid_size_factor</a>);
<a name="l00250"></a>00250           uint32_t npost = 
<a name="l00251"></a>00251             std::ceil(channel.<a class="code" href="classV172X__ChannelParams.html#a17371e42dd5b945758d9f217df519a7a" title="number of samples to save before zle block">zs_pre_samps</a>/board.<a class="code" href="classV172X__BoardParams.html#a1149113e2bad5aec06252fda10669209" title="determines packing of samples in mem">stupid_size_factor</a>);
<a name="l00252"></a>00252           nsamp = (npre&lt;&lt;16) + npost;
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254         <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_ChZSNsamples+i*0x100, nsamp, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00255"></a>00255         <span class="comment">//trigger threshold</span>
<a name="l00256"></a>00256         <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_ChTrigThresh+i*0x100, 
<a name="l00257"></a>00257                          channel.<a class="code" href="classV172X__ChannelParams.html#ae707e5163e2a252d35a216add5a295f3" title="trigger threshold in counts">threshold</a>, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00258"></a>00258         <span class="comment">//time over trigger threhsold</span>
<a name="l00259"></a>00259         nsamp = std::ceil(channel.<a class="code" href="classV172X__ChannelParams.html#a1842a35fba56a5928c35f8170fff0cae" title="time signal must be above/below threshold">thresh_time_us</a> * board.<a class="code" href="classV172X__BoardParams.html#afad0deefe7bd788595029bb3090e4dc6" title="Get the sample rate used, in samples per microsecond.">GetSampleRate</a>()) 
<a name="l00260"></a>00260           / board.<a class="code" href="classV172X__BoardParams.html#a1149113e2bad5aec06252fda10669209" title="determines packing of samples in mem">stupid_size_factor</a>;
<a name="l00261"></a>00261         
<a name="l00262"></a>00262         <span class="keywordflow">if</span>(nsamp &gt;= (1&lt;&lt;12)) nsamp = (1&lt;&lt;12) - 1;
<a name="l00263"></a>00263         <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_ChTrigSamples+i*0x100, nsamp, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00264"></a>00264         <span class="comment">//dc offset</span>
<a name="l00265"></a>00265         <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_ChDAC+i*0x100, channel.<a class="code" href="classV172X__ChannelParams.html#aa947262e3eb2ca58fe4aac5bc9bd1619" title="dc offset applied to signal">dc_offset</a>, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00266"></a>00266         <span class="comment">//wait until the dac has updated</span>
<a name="l00267"></a>00267         uint32_t status = 0x4;
<a name="l00268"></a>00268         <span class="keywordflow">while</span>( channel.<a class="code" href="classV172X__ChannelParams.html#a15388de4aee725bee8f317a41938fe6c" title="is this channel enabled?">enabled</a> &amp;&amp;( (status&amp;0x4) || !(status&amp;0x2)) ){
<a name="l00269"></a>00269           <span class="comment">//std::cerr&lt;&lt;&quot;Waiting for channel &quot;&lt;&lt;i&lt;&lt;&quot; of board &quot;&lt;&lt;iboard&lt;&lt;&quot; to update DAC...&quot;;</span>
<a name="l00270"></a>00270           status = <a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_ChStatus +i*0x100, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00271"></a>00271           <span class="comment">//std::cerr&lt;&lt;&quot; status is now &quot;&lt;&lt;status&lt;&lt;std::endl;</span>
<a name="l00272"></a>00272         }
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274       <span class="comment">//finish up with the board parameters</span>
<a name="l00275"></a>00275       uint32_t channel_config = (1&lt;&lt;16) * board.<a class="code" href="classV172X__BoardParams.html#a3c540f3a5a6b35cca846738143c5ad41" title="do any zero suppression?">zs_type</a> + 
<a name="l00276"></a>00276         (1&lt;&lt;6) * board.<a class="code" href="classV172X__BoardParams.html#af025930a165be408183671436978731b" title="trigger on rising or falling signals">trigger_polarity</a> + 
<a name="l00277"></a>00277         (1&lt;&lt;4) + <span class="comment">//Memory Sequential access</span>
<a name="l00278"></a>00278         (1&lt;&lt;3) * board.<a class="code" href="classV172X__BoardParams.html#aed94bd676843ac41a9f90c9f38b7c91a" title="generate a test pattern internally?">enable_test_pattern</a> + 
<a name="l00279"></a>00279         (1&lt;&lt;1) * board.<a class="code" href="classV172X__BoardParams.html#abd4c5343cb2816e18c84a652e7754121" title="generate partial triggers windows?">enable_trigger_overlap</a>;
<a name="l00280"></a>00280       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_ChannelsConfig, channel_config, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00281"></a>00281       <span class="comment">//Buffer code (determines total trigger time</span>
<a name="l00282"></a>00282       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_BufferCode, board.<a class="code" href="classV172X__BoardParams.html#af3b3b83e2be04bfdb6133245da90ae00" title="number of triggers that can be stored in buffer is 2^n">GetBufferCode</a>(), <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00283"></a>00283       <span class="comment">//Custom size of register</span>
<a name="l00284"></a>00284       
<a name="l00285"></a>00285       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_CustomSize, 
<a name="l00286"></a>00286                        board.<a class="code" href="classV172X__BoardParams.html#ab81a4a919b433f4f352fa2d9cc36a441" title="Get the value to write to the custom size register.">GetCustomSizeSetting</a>(), <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00287"></a>00287       
<a name="l00288"></a>00288       <span class="comment">//Acquisition Control</span>
<a name="l00289"></a>00289       uint32_t acq_control =  
<a name="l00290"></a>00290         (1&lt;&lt;3) * board.<a class="code" href="classV172X__BoardParams.html#a8d432375d07f9f13ca518079dffd66bd" title="count triggers that overlap?">count_all_triggers</a> +
<a name="l00291"></a>00291         <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39778fccabd270f58585798100feca91" title="synchronize start of run on all boards?">send_start_pulse</a>;
<a name="l00292"></a>00292 <span class="comment">//      acq_control = (1&lt;&lt;3) * board.count_all_triggers + 4;</span>
<a name="l00293"></a>00293       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_AcquisitionControl,acq_control, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00294"></a>00294       board.<a class="code" href="classV172X__BoardParams.html#a986c9e16d36e6e453a565bc9538c0fa6" title="determines startup mode">acq_control_val</a> = acq_control;
<a name="l00295"></a>00295       <span class="comment">//trigger mask</span>
<a name="l00296"></a>00296       <span class="keywordflow">if</span>(board.<a class="code" href="classV172X__BoardParams.html#aa49640f0cf80d93360742ee45519041c" title="need n+1 channels to trigger locally">local_trigger_coincidence</a> &gt;7) 
<a name="l00297"></a>00297         board.<a class="code" href="classV172X__BoardParams.html#aa49640f0cf80d93360742ee45519041c" title="need n+1 channels to trigger locally">local_trigger_coincidence</a> = 7;
<a name="l00298"></a>00298       trigger_mask += (1&lt;&lt;31) * board.<a class="code" href="classV172X__BoardParams.html#a8e08d36bd23b8f65cef70fa5243cdcd1" title="do we allow softwre triggers?">enable_software_trigger</a> 
<a name="l00299"></a>00299         + (1&lt;&lt;30) * board.<a class="code" href="classV172X__BoardParams.html#adb6852debcc3d49a2a5d58e4fc20b944" title="do we allow external triggers?">enable_external_trigger</a>
<a name="l00300"></a>00300         + (1&lt;&lt;24) * board.<a class="code" href="classV172X__BoardParams.html#aa49640f0cf80d93360742ee45519041c" title="need n+1 channels to trigger locally">local_trigger_coincidence</a>;
<a name="l00301"></a>00301       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_TrigSourceMask, trigger_mask, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00302"></a>00302       <span class="comment">//trigger out mask</span>
<a name="l00303"></a>00303       trigger_out_mask += (1&lt;&lt;31) * board.<a class="code" href="classV172X__BoardParams.html#ae9b55210f15ec17003ceecfb204c6cd9" title="do soft triggers generate sig out?">enable_software_trigger_out</a> +
<a name="l00304"></a>00304         (1&lt;&lt;30) * board.<a class="code" href="classV172X__BoardParams.html#a04a12a52df0101c8c42577df274648a2" title="do we repeat external trigs out?">enable_external_trigger_out</a>;
<a name="l00305"></a>00305       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_TrigOutMask, trigger_out_mask, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00306"></a>00306       <span class="comment">//post trigger setting</span>
<a name="l00307"></a>00307       
<a name="l00308"></a>00308       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_PostTriggerSetting, 
<a name="l00309"></a>00309                        board.<a class="code" href="classV172X__BoardParams.html#a5ff5c226c1c59b3eab4bd1d4da2b51b5" title="Get the value to write to the post samples register.">GetPostTriggerSetting</a>(), <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00310"></a>00310       <span class="comment">//signal logic and front panel programming</span>
<a name="l00311"></a>00311       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_FrontPanelIO,
<a name="l00312"></a>00312                        board.<a class="code" href="classV172X__BoardParams.html#ac06bd1029fdbc75e419b10b756cf19e5" title="use NIM or TTL signals?">signal_logic</a> + (1&lt;&lt;6), <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00313"></a>00313       <span class="comment">//channel mask</span>
<a name="l00314"></a>00314       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_ChannelMask, channel_mask, 
<a name="l00315"></a>00315                        <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00316"></a>00316       <span class="comment">//VME control</span>
<a name="l00317"></a>00317       uint32_t vme_control = (1&lt;&lt;5) * <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#af17f68bdbb27446e2607d8dc71527dd4" title="do we need to read an extra sample?">align64</a> + 
<a name="l00318"></a>00318         (1&lt;&lt;4) + <span class="comment">//enable bus error</span>
<a name="l00319"></a>00319         (1&lt;&lt;3) + <span class="comment">//enable optical link error</span>
<a name="l00320"></a>00320         1; <span class="comment">//interrupt level</span>
<a name="l00321"></a>00321       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_VMEControl, vme_control, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00322"></a>00322       <span class="comment">//Interrupt num, BLT event num</span>
<a name="l00323"></a>00323       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_InterruptOnEvent, 0, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00324"></a>00324       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_BLTEvents, 1, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00325"></a>00325       <span class="comment">//wait until the board is ready to take data</span>
<a name="l00326"></a>00326       uint32_t status = 0;
<a name="l00327"></a>00327       <span class="keywordtype">int</span> count = 0;
<a name="l00328"></a>00328       <span class="keywordflow">while</span>( !((status&amp;0x100) &amp;&amp; (status&amp;0xc0)) ){
<a name="l00329"></a>00329         status = <a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_AcquisitionStatus, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[iboard]);
<a name="l00330"></a>00330         <span class="keywordflow">if</span>(count++ &gt; 500){
<a name="l00331"></a>00331           <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Unable to initialize board &quot;</span>&lt;&lt;iboard&lt;&lt;<span class="stringliteral">&quot; at address &quot;</span>
<a name="l00332"></a>00332                         &lt;&lt;std::hex&lt;&lt;board.<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>&lt;&lt;std::dec&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00333"></a>00333           <span class="keywordflow">return</span> 1;
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335       }
<a name="l00336"></a>00336       
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338     <span class="comment">/*Find the max expected event size in bytes</span>
<a name="l00339"></a>00339 <span class="comment">    The header size is 16 bytes per board</span>
<a name="l00340"></a>00340 <span class="comment">    The data size is 2 bytes per sample per channel</span>
<a name="l00341"></a>00341 <span class="comment">    */</span>
<a name="l00342"></a>00342     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;The expected event size is &quot;</span>&lt;&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a58642b3859b45fae4b485c09edbf1d50" title="Get the expected total event size in bytes.">GetEventSize</a>()
<a name="l00343"></a>00343                   &lt;&lt;<span class="stringliteral">&quot; bytes.&quot;</span>&lt;&lt;std::endl;   
<a name="l00344"></a>00344     <span class="comment">//wait 2 seconds for DC offset levels to adjust</span>
<a name="l00345"></a>00345     time_t now = time(0);
<a name="l00346"></a>00346     <span class="keywordflow">while</span>(time(0) - now &lt; 2) {}
<a name="l00347"></a>00347   }
<a name="l00348"></a>00348   <span class="keywordflow">catch</span>(...){ 
<a name="l00349"></a>00349     <span class="keywordflow">return</span> -3;
<a name="l00350"></a>00350   }
<a name="l00351"></a>00351   <span class="keywordflow">return</span> 0;
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="comment">//predicate for find_if function used to test if any board has data</span>
<a name="l00355"></a>00355 <span class="keywordtype">bool</span> DataAvailable(uint32_t status)
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357   <span class="keywordflow">return</span> (status &amp; 0x8);
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a><a class="code" href="classV172X__Daq.html#a04e577ee1fc864f63eeea4b5faee9b38">00360</a> <span class="keywordtype">void</span> <a class="code" href="classV172X__Daq.html#a04e577ee1fc864f63eeea4b5faee9b38" title="Acquire the data from the hardware and store in _events_queue.">V172X_Daq::DataAcquisitionLoop</a>()
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362   <span class="keywordflow">if</span>(!<a class="code" href="classV172X__Daq.html#afbaee15650b78da67e46cbd2ecd91b67" title="Is hardware initialized?">_initialized</a>) <a class="code" href="classV172X__Daq.html#a0600101d6215d2c143e7022e55ed44bd" title="Initialize the hardware communication.">Initialize</a>();
<a name="l00363"></a>00363   <span class="comment">//prepare some variables</span>
<a name="l00364"></a>00364   <a class="code" href="classV172X__Daq.html#a92d4e4af281216a4b1818f14f91c408d" title="total triggers received so far">_triggers</a> = 0;
<a name="l00365"></a>00365   std::vector&lt;uint32_t&gt; acq_status(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aefec64903a47b9c984a48cd7bf2f230f" title="number of boards enabled in this run">enabled_boards</a>);
<a name="l00366"></a>00366   <span class="comment">//Arm the boards</span>
<a name="l00367"></a>00367   <span class="keywordflow">try</span>{
<a name="l00368"></a>00368     std::vector&lt;uint32_t&gt; acq_write;
<a name="l00369"></a>00369     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++){
<a name="l00370"></a>00370       <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a>){
<a name="l00371"></a>00371         acq_write.push_back(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a986c9e16d36e6e453a565bc9538c0fa6" title="determines startup mode">acq_control_val</a>+0x4);
<a name="l00372"></a>00372       }
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374     <a class="code" href="classV172X__Daq.html#aca00440a737534a44b2c3d733e6c503a">WriteVMERegisters</a>(VME_SWClear,1);
<a name="l00375"></a>00375     <a class="code" href="classV172X__Daq.html#aca00440a737534a44b2c3d733e6c503a">WriteVMERegisters</a>(VME_AcquisitionControl,&amp;(acq_write[0]));
<a name="l00376"></a>00376     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39778fccabd270f58585798100feca91" title="synchronize start of run on all boards?">send_start_pulse</a>)
<a name="l00377"></a>00377       CAENVME_SetOutputRegister(<a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>, 
<a name="l00378"></a>00378                                 cvOut0Bit | cvOut1Bit | cvOut2Bit | 
<a name="l00379"></a>00379                                 cvOut3Bit | cvOut4Bit );
<a name="l00380"></a>00380   }
<a name="l00381"></a>00381   <span class="keywordflow">catch</span>(std::exception&amp; e){
<a name="l00382"></a>00382     <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Unable to arm the board for run!\n&quot;</span>;
<a name="l00383"></a>00383     <a class="code" href="classV172X__Daq.html#afbaee15650b78da67e46cbd2ecd91b67" title="Is hardware initialized?">_initialized</a>=<span class="keyword">false</span>;
<a name="l00384"></a>00384     <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a>=<a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aa5d0fd9dfb083002684f010497c2122f3" title="enum value: Initialization Failure">INIT_FAILURE</a>;
<a name="l00385"></a>00385     <span class="keywordflow">return</span>;
<a name="l00386"></a>00386   }
<a name="l00387"></a>00387   int32_t irq_handle = <a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>;
<a name="l00388"></a>00388   <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad743f043d73f01d77fa4a9cb39235ea5" title="the caenvmelib link number for the VME bridge">vme_bridge_link</a>) 
<a name="l00389"></a>00389     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++) { 
<a name="l00390"></a>00390       irq_handle = <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]; 
<a name="l00391"></a>00391       <span class="keywordflow">if</span> (<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a> &amp;&amp; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3ea82f5585a422a5a2b2446acdcc9271" title="the caenvmelib link number for this board or the vme bridge">link</a> &gt;= 0) <span class="keywordflow">break</span>;
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393   
<a name="l00394"></a>00394   <span class="comment">//figure out whether we can use interrupts</span>
<a name="l00395"></a>00395   <span class="comment">//usb interface can&apos;t do interrupts, so use polling only</span>
<a name="l00396"></a>00396   
<a name="l00397"></a>00397   <span class="keywordtype">bool</span> use_interrupt = <span class="keyword">true</span>;
<a name="l00398"></a>00398   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++){
<a name="l00399"></a>00399     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a> &amp;&amp; <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a517967a27b836c97e03ff749b19c0bb2" title="connect through usb instead of optical link?">usb</a>) 
<a name="l00400"></a>00400       use_interrupt = <span class="keyword">false</span>;
<a name="l00401"></a>00401   }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403   
<a name="l00404"></a>00404   <span class="keywordflow">while</span>(<a class="code" href="classBaseDaq.html#a2a3eb7573c21e7107a48fd91fee64253" title="is the daq running?">_is_running</a> ){
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     CVErrorCodes err = cvTimeoutError;
<a name="l00407"></a>00407     
<a name="l00408"></a>00408     <span class="keywordflow">if</span>(use_interrupt){
<a name="l00409"></a>00409       <span class="comment">//Enable IRQ lines and wait for an interrupt</span>
<a name="l00410"></a>00410       CAENVME_IRQEnable(irq_handle,0xFF);
<a name="l00411"></a>00411       err = CAENVME_IRQWait(irq_handle,0xFF,
<a name="l00412"></a>00412                                          <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad69bbaa4f3fee5458ce06cfdda9b52d5" title="how long to wait for trigger interrupt">trigger_timeout_ms</a>);
<a name="l00413"></a>00413       CAENVME_IRQDisable(irq_handle,0xFF);
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415     <span class="keywordflow">else</span>{
<a name="l00416"></a>00416       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++){
<a name="l00417"></a>00417         <span class="keywordflow">if</span>(!<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a>) <span class="keywordflow">continue</span>;
<a name="l00418"></a>00418         <span class="comment">//see if there is an event ready on the board</span>
<a name="l00419"></a>00419         <span class="keywordflow">if</span>(DataAvailable(<a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+
<a name="l00420"></a>00420                                          VME_AcquisitionStatus, 
<a name="l00421"></a>00421                                          <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i])) ){
<a name="l00422"></a>00422           err = cvSuccess;
<a name="l00423"></a>00423           <span class="keywordflow">break</span>;
<a name="l00424"></a>00424         }
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="comment">//Check to see if there was an interrupt or just the timeout</span>
<a name="l00429"></a>00429     <span class="keywordflow">switch</span>(err){
<a name="l00430"></a>00430     <span class="keywordflow">case</span> cvSuccess:
<a name="l00431"></a>00431       <span class="keywordflow">break</span>;
<a name="l00432"></a>00432     <span class="keywordflow">case</span> cvGenericError:
<a name="l00433"></a>00433       <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Generic error occurred. Probably just a timeout...\n&quot;</span>;
<a name="l00434"></a>00434       <span class="comment">//notice: no break here!</span>
<a name="l00435"></a>00435     <span class="keywordflow">case</span> cvTimeoutError:
<a name="l00436"></a>00436       <span class="keywordflow">if</span>(!use_interrupt){
<a name="l00437"></a>00437         <span class="comment">//sleep for the timeout interval</span>
<a name="l00438"></a>00438         boost::this_thread::sleep(
<a name="l00439"></a>00439             boost::posix_time::millisec(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#ad69bbaa4f3fee5458ce06cfdda9b52d5" title="how long to wait for trigger interrupt">trigger_timeout_ms</a>));
<a name="l00440"></a>00440       }
<a name="l00441"></a>00441       <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a11b9a59003f713dd1178b89bcdd2b4dd" title="allow computer to generate triggers?">auto_trigger</a>){
<a name="l00442"></a>00442         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Triggering...\n&quot;</span>;
<a name="l00443"></a>00443         <a class="code" href="classV172X__Daq.html#aca00440a737534a44b2c3d733e6c503a">WriteVMERegisters</a>(VME_SWTrigger,1);
<a name="l00444"></a>00444       }
<a name="l00445"></a>00445       <span class="keywordflow">else</span>
<a name="l00446"></a>00446         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Waiting for trigger...&quot;</span>&lt;&lt;std::endl;
<a name="l00447"></a>00447       <span class="keywordflow">continue</span>;
<a name="l00448"></a>00448       <span class="keywordflow">break</span>;
<a name="l00449"></a>00449     <span class="keywordflow">default</span>:
<a name="l00450"></a>00450       <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Unknown error waiting for trigger interrupt\n&quot;</span>;
<a name="l00451"></a>00451       <span class="keywordflow">break</span>;
<a name="l00452"></a>00452     }
<a name="l00453"></a>00453     
<a name="l00454"></a>00454     <span class="comment">//if we get here, there is an event ready for download</span>
<a name="l00455"></a>00455     <span class="comment">//get a new event ready </span>
<a name="l00456"></a>00456     <a class="code" href="group__daqman.html#ga0f82e6cccd71bdffb21c8b72eb91a662">RawEventPtr</a> next_event(<span class="keyword">new</span> <a class="code" href="classRawEvent.html" title="Container for a block of raw data.">RawEvent</a>);
<a name="l00457"></a>00457     <span class="keywordtype">size_t</span> blocknum = 
<a name="l00458"></a>00458       next_event-&gt;AddDataBlock(RawEvent::CAEN_V172X,
<a name="l00459"></a>00459                                <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a124c21834b30cc9580ef5a1468075478" title="total size of events">event_size_bytes</a>+event_size_padding);
<a name="l00460"></a>00460     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buffer = next_event-&gt;GetRawDataBlock(blocknum);
<a name="l00461"></a>00461     <span class="keyword">const</span> uint32_t UNSET_EVENT_COUNTER = 0xFFFFFFFF;
<a name="l00462"></a>00462     uint32_t event_counter = UNSET_EVENT_COUNTER;
<a name="l00463"></a>00463     <span class="comment">//get the data</span>
<a name="l00464"></a>00464     <span class="keywordtype">int</span> data_transferred = 0;
<a name="l00465"></a>00465     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++){
<a name="l00466"></a>00466       <span class="keywordflow">if</span>(!<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a>) <span class="keywordflow">continue</span>;
<a name="l00467"></a>00467       <span class="comment">//wait until the event is ready on the board</span>
<a name="l00468"></a>00468       
<a name="l00469"></a>00469       <span class="keywordtype">int</span> tries = 0;
<a name="l00470"></a>00470       <span class="keyword">const</span> <span class="keywordtype">int</span> maxtries = 50;
<a name="l00471"></a>00471       <span class="keywordflow">while</span>(!DataAvailable(<a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+
<a name="l00472"></a>00472                                            VME_AcquisitionStatus, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i])) &amp;&amp;
<a name="l00473"></a>00473             tries++ &lt; maxtries) {}
<a name="l00474"></a>00474       <span class="keywordflow">if</span>(tries &gt;= maxtries){
<a name="l00475"></a>00475         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;No trigger received on board &quot;</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00476"></a>00476         <span class="keywordflow">continue</span>;
<a name="l00477"></a>00477       }
<a name="l00478"></a>00478       
<a name="l00479"></a>00479       <span class="keywordtype">int</span> this_dl_size = 0;
<a name="l00480"></a>00480       tries=0;
<a name="l00481"></a>00481       CVErrorCodes err = cvSuccess;
<a name="l00482"></a>00482       <span class="keywordflow">while</span>(this_dl_size == 0 &amp;&amp; ++tries&lt;maxtries ){
<a name="l00483"></a>00483         err = 
<a name="l00484"></a>00484           CAENVME_FIFOBLTReadCycle(<a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i], <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>,
<a name="l00485"></a>00485                                    buffer + data_transferred,
<a name="l00486"></a>00486                                    <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3c2f6ad2e9d4c5ee8552d8a942abb5cd" title="expected size of a single event">event_size_bytes</a>,
<a name="l00487"></a>00487                                    cvA32_U_MBLT, cvD64, &amp;this_dl_size);
<a name="l00488"></a>00488         <span class="keywordflow">if</span>(err != cvSuccess &amp;&amp; err != cvBusError){
<a name="l00489"></a>00489           <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Error generated while downloading event from board&quot;</span>
<a name="l00490"></a>00490                         &lt;&lt;i&lt;&lt;<span class="stringliteral">&quot;: &quot;</span>&lt;&lt;CAENVME_DecodeError(err)&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00491"></a>00491           <span class="keywordflow">continue</span>;
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493       }
<a name="l00494"></a>00494       
<a name="l00495"></a>00495       <span class="keywordflow">if</span>(this_dl_size&lt;=0){
<a name="l00496"></a>00496         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;0 bytes downloaded for board &quot;</span>&lt;&lt;i&lt;&lt;std::endl;
<a name="l00497"></a>00497         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Events stored on this board: &quot;</span>
<a name="l00498"></a>00498                       &lt;&lt;<a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+
<a name="l00499"></a>00499                                         VME_EventsStored, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i])&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00500"></a>00500         uint32_t out;
<a name="l00501"></a>00501         out = <a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_VMEStatus, 
<a name="l00502"></a>00502                               <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00503"></a>00503         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;VME status:&quot;</span>
<a name="l00504"></a>00504                       &lt;&lt;<span class="stringliteral">&quot;\n\tBERR flag: &quot;</span>&lt;&lt; (out&amp;4)
<a name="l00505"></a>00505                       &lt;&lt;<span class="stringliteral">&quot;\n\tOutput buffer full: &quot;</span>&lt;&lt; (out&amp;2)
<a name="l00506"></a>00506                       &lt;&lt;<span class="stringliteral">&quot;\n\tData ready: &quot;</span>&lt;&lt; (out&amp;1)&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00507"></a>00507         out = <a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_AcquisitionStatus, 
<a name="l00508"></a>00508                               <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00509"></a>00509         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Acquisition status:&quot;</span>
<a name="l00510"></a>00510                       &lt;&lt;<span class="stringliteral">&quot;\n\tReady for acquisition: &quot;</span>&lt;&lt; (out&amp;256)
<a name="l00511"></a>00511                       &lt;&lt;<span class="stringliteral">&quot;\n\tPLL Status: &quot;</span>&lt;&lt; (out&amp;128)
<a name="l00512"></a>00512                       &lt;&lt;<span class="stringliteral">&quot;\n\tPLL Bypass: &quot;</span>&lt;&lt; (out&amp;64)
<a name="l00513"></a>00513                       &lt;&lt;<span class="stringliteral">&quot;\n\tClock source: &quot;</span>&lt;&lt; (out&amp;32)
<a name="l00514"></a>00514                       &lt;&lt;<span class="stringliteral">&quot;\n\tEvents full: &quot;</span>&lt;&lt; (out&amp;16)
<a name="l00515"></a>00515                       &lt;&lt;<span class="stringliteral">&quot;\n\tEvent ready: &quot;</span>&lt;&lt; (out&amp;8)
<a name="l00516"></a>00516                       &lt;&lt;<span class="stringliteral">&quot;\n\t Run on: &quot;</span>&lt;&lt; (out&amp;4) &lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00517"></a>00517         out = <a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_EventSize, 
<a name="l00518"></a>00518                               <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00519"></a>00519         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Next event size: &quot;</span>&lt;&lt;out&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00520"></a>00520         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Expected event size &quot;</span>
<a name="l00521"></a>00521                       &lt;&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3c2f6ad2e9d4c5ee8552d8a942abb5cd" title="expected size of a single event">event_size_bytes</a>/4&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00522"></a>00522         
<a name="l00523"></a>00523         
<a name="l00524"></a>00524         <span class="comment">//free the buffer so we don&apos;t re-trigger spuriously</span>
<a name="l00525"></a>00525         <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_BufferFree,1, 
<a name="l00526"></a>00526                          <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00527"></a>00527         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Events stored on this board: &quot;</span>
<a name="l00528"></a>00528                       &lt;&lt;<a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+
<a name="l00529"></a>00529                                         VME_EventsStored, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i])
<a name="l00530"></a>00530                       &lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00531"></a>00531         <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_BufferFree,2, 
<a name="l00532"></a>00532                          <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00533"></a>00533         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<span class="stringliteral">&quot;Events stored on this board: &quot;</span>
<a name="l00534"></a>00534                       &lt;&lt;<a class="code" href="classV172X__Daq.html#a9ab57138d4b5f5ba2c14b85060cfdaa4" title="Read data from the VME register &amp;lt;address&amp;gt;.">ReadVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+
<a name="l00535"></a>00535                                         VME_EventsStored, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i])
<a name="l00536"></a>00536                       &lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00537"></a>00537         <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Boards don&apos;t usually recover from this error! &quot;</span>
<a name="l00538"></a>00538                       &lt;&lt;<span class="stringliteral">&quot;Aborting!\n&quot;</span>;
<a name="l00539"></a>00539         <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a> = <a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aab7bedce7cf9a68133c2c9c6402192116" title="enum value: Communication Error">COMM_ERROR</a>;
<a name="l00540"></a>00540         <a class="code" href="classBaseDaq.html#a2a3eb7573c21e7107a48fd91fee64253" title="is the daq running?">_is_running</a> = <span class="keyword">false</span>;
<a name="l00541"></a>00541         <span class="keywordflow">break</span>;
<a name="l00542"></a>00542       }
<a name="l00543"></a>00543       <span class="keywordflow">else</span>{
<a name="l00544"></a>00544         
<a name="l00545"></a>00545         <span class="comment">//this could ignore potential align64 extra bits:</span>
<a name="l00546"></a>00546         <span class="comment">//data_transferred += this_dl_size;</span>
<a name="l00547"></a>00547         <span class="comment">//instead, we check the actual event</span>
<a name="l00548"></a>00548         <span class="keywordtype">long</span> ev_size = (*((uint32_t*)(buffer+data_transferred)) &amp; 
<a name="l00549"></a>00549                              0x0FFFFFFF) * <span class="keyword">sizeof</span>(uint32_t);
<a name="l00550"></a>00550         <span class="keywordflow">if</span>(std::abs(ev_size - this_dl_size) &gt; 5){
<a name="l00551"></a>00551           <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(WARNING)&lt;&lt;<span class="stringliteral">&quot;Event size does not match download count!\n\t&quot;</span>
<a name="l00552"></a>00552                           &lt;&lt;<span class="stringliteral">&quot;Event size: &quot;</span>&lt;&lt;ev_size&lt;&lt;<span class="stringliteral">&quot;; download size: &quot;</span>
<a name="l00553"></a>00553                           &lt;&lt;this_dl_size&lt;&lt;<span class="stringliteral">&quot;; requested download &quot;</span>
<a name="l00554"></a>00554                           &lt;&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a3c2f6ad2e9d4c5ee8552d8a942abb5cd" title="expected size of a single event">event_size_bytes</a>&lt;&lt;std::endl;
<a name="l00555"></a>00555           <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;Boards don&apos;t usually recover from this error! &quot;</span>
<a name="l00556"></a>00556                       &lt;&lt;<span class="stringliteral">&quot;Aborting!\n&quot;</span>;
<a name="l00557"></a>00557           <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a> = <a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aab7bedce7cf9a68133c2c9c6402192116" title="enum value: Communication Error">COMM_ERROR</a>;
<a name="l00558"></a>00558           <a class="code" href="classBaseDaq.html#a2a3eb7573c21e7107a48fd91fee64253" title="is the daq running?">_is_running</a> = <span class="keyword">false</span>;
<a name="l00559"></a>00559           <span class="keywordflow">break</span>;
<a name="l00560"></a>00560         }
<a name="l00561"></a>00561         <span class="comment">//check for event ID misalignment</span>
<a name="l00562"></a>00562         uint32_t evct = (((uint32_t*)(buffer+data_transferred))[2])&amp;0xFFFFFF;
<a name="l00563"></a>00563         <span class="keywordflow">if</span>(event_counter == UNSET_EVENT_COUNTER)
<a name="l00564"></a>00564           event_counter = evct;
<a name="l00565"></a>00565         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(evct != event_counter){
<a name="l00566"></a>00566           <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(CRITICAL)&lt;&lt;<span class="stringliteral">&quot;Mismatched event ID on board &quot;</span>&lt;&lt;i
<a name="l00567"></a>00567                            &lt;&lt;<span class="stringliteral">&quot;; received &quot;</span>&lt;&lt;evct&lt;&lt;<span class="stringliteral">&quot;, expected &quot;</span>&lt;&lt;event_counter
<a name="l00568"></a>00568                            &lt;&lt;<span class="stringliteral">&quot;; Aboring run\n&quot;</span>;
<a name="l00569"></a>00569           <a class="code" href="classBaseDaq.html#a231f99398eeec02f020d57962926cdbe" title="the status of the daq">_status</a> = <a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aa5b42dd8537587db22f8e22797eb7a5cf" title="enum value: Generic Error">GENERIC_ERROR</a>;
<a name="l00570"></a>00570           <a class="code" href="classBaseDaq.html#a2a3eb7573c21e7107a48fd91fee64253" title="is the daq running?">_is_running</a>=<span class="keyword">false</span>;
<a name="l00571"></a>00571           <span class="keywordflow">break</span>;
<a name="l00572"></a>00572         }
<a name="l00573"></a>00573       
<a name="l00574"></a>00574         data_transferred += ev_size;
<a name="l00575"></a>00575         
<a name="l00576"></a>00576       }
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578     <span class="keywordflow">if</span>(<a class="code" href="classBaseDaq.html#a28b91cf8f451e0c2506348583204d578" title="Get the status of the DAQ.">GetStatus</a>() != <a class="code" href="classBaseDaq.html#a6d79d523b3df7acbc38fc006b8b3600aa7ab0f619c508dcab01c2afdfe3fa419f" title="enum value: Status is normal">NORMAL</a>){
<a name="l00579"></a>00579       <a class="code" href="classBaseDaq.html#a2a3eb7573c21e7107a48fd91fee64253" title="is the daq running?">_is_running</a> = <span class="keyword">false</span>;
<a name="l00580"></a>00580       <span class="keywordflow">break</span>;
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582     <span class="keywordflow">if</span>(data_transferred &lt;= 0){
<a name="l00583"></a>00583       <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(ERROR)&lt;&lt;<span class="stringliteral">&quot;No boards transferred usable data this event!\n&quot;</span>;
<a name="l00584"></a>00584       <span class="keywordflow">continue</span>;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586     <span class="keywordflow">else</span>{
<a name="l00587"></a>00587       <a class="code" href="classV172X__Daq.html#a92d4e4af281216a4b1818f14f91c408d" title="total triggers received so far">_triggers</a>++;
<a name="l00588"></a>00588       next_event-&gt;SetDataBlockSize(blocknum, data_transferred);
<a name="l00589"></a>00589       <a class="code" href="classBaseDaq.html#aa41a3555baed2fcdb1d3d2256566cd56" title="Send a new RawEvent to whoever is waiting.">PostEvent</a>(next_event);
<a name="l00590"></a>00590     }    
<a name="l00591"></a>00591   }<span class="comment">//end while(_is_running)</span>
<a name="l00592"></a>00592    <span class="comment">//We only reach here once the event has stopped, so clean up any mess</span>
<a name="l00593"></a>00593   <span class="comment">//First, end the run, and clear the buffers</span>
<a name="l00594"></a>00594   <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39778fccabd270f58585798100feca91" title="synchronize start of run on all boards?">send_start_pulse</a>)
<a name="l00595"></a>00595     CAENVME_ClearOutputRegister(<a class="code" href="classV172X__Daq.html#a1cb7dfe53837ed1cb9686cf70d446e1a" title="caenvme opaque id for vme_bridge">_handle_vme_bridge</a>, 0xFFFF);
<a name="l00596"></a>00596   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#a39fce0d8eb0869d8b5c9b8596c9b7700" title="max number of boards allowed">nboards</a>; i++){
<a name="l00597"></a>00597     <span class="keywordflow">if</span>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a66b10413b8e533ee0f879e1a4c4d1198" title="is this board enabled?">enabled</a>){
<a name="l00598"></a>00598       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+ VME_AcquisitionControl,
<a name="l00599"></a>00599                        <a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#a986c9e16d36e6e453a565bc9538c0fa6" title="determines startup mode">acq_control_val</a>, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00600"></a>00600       <a class="code" href="classV172X__Daq.html#a0019d994d83f976780855845a741e5a1">WriteVMERegister</a>(<a class="code" href="classV172X__Daq.html#a1efb4af16281ff5b5ba4892789f1301a" title="parameters for the boards">_params</a>.<a class="code" href="classV172X__Params.html#aaee3121553af3a23717be381d1d167eb" title="parameters for each board">board</a>[i].<a class="code" href="classV172X__BoardParams.html#ace8a5ebb74dd3409a8ce8843e81fcd50" title="this board&amp;#39;s VME address">address</a>+VME_SWClear,0x1, <a class="code" href="classV172X__Daq.html#a3f521df2e13624dd150084e1e61cf7fa" title="caenvme opaque id for boards">_handle_board</a>[i]);
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602   }
<a name="l00603"></a>00603   <a class="code" href="classV172X__Daq.html#aca00440a737534a44b2c3d733e6c503a">WriteVMERegisters</a>(VME_SWReset,1);
<a name="l00604"></a>00604   <a class="code" href="classMessage.html" title="Thread-safe streaming utility with settable threshold.">Message</a>(DEBUG)&lt;&lt;<a class="code" href="classV172X__Daq.html#a92d4e4af281216a4b1818f14f91c408d" title="total triggers received so far">_triggers</a>&lt;&lt;<span class="stringliteral">&quot; total triggers downloaded.&quot;</span>&lt;&lt;std::endl;
<a name="l00605"></a>00605 }  
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 20 Jun 2014 for daqman by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
