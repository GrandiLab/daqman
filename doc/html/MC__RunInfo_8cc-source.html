<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>daqman: mc/src/MC_RunInfo.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_6997d34df620df61b39bcd96905aea5f.html">mc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_60c41cc2e81cc7c1535ef186c27e5083.html">src</a></div>
<h1>MC_RunInfo.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="MC__RunInfo_8hh.html">MC_RunInfo.hh</a>"</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include "<a class="code" href="Message_8hh.html">Message.hh</a>"</span>
<a name="l00003"></a>00003 <span class="comment">// #include &lt;exception&gt;</span>
<a name="l00004"></a>00004 <span class="comment">// #include &lt;stdexcept&gt;</span>
<a name="l00005"></a>00005 <span class="comment">// #include &lt;math.h&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">using namespace </span>std;
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="classMC__RunInfo.html#8c1720caee5a85dd2cdfcaba5e3a79f5">00009</a> <a class="code" href="classMC__RunInfo.html#8c1720caee5a85dd2cdfcaba5e3a79f5">MC_RunInfo::MC_RunInfo</a>() : <a class="code" href="classParameterList.html">ParameterList</a>(<span class="stringliteral">"runinfo"</span>) {
<a name="l00010"></a>00010 
<a name="l00011"></a>00011   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"runid"</span>, <a class="code" href="group__mc.html#g4c87fae8d04a178938e3102f8e1732c4">runid</a>, <span class="stringliteral">"unique ID number for the run"</span>);
<a name="l00012"></a>00012   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"starttime"</span>,<a class="code" href="group__mc.html#gad7a18eed862df8e5dd8be9a4917df33">starttime</a>,<span class="stringliteral">"Timestamp at start of run"</span>);
<a name="l00013"></a>00013   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"endtime"</span>,<a class="code" href="group__mc.html#gfe15a95ba510b965cde1c8e2531eed67">endtime</a>, <span class="stringliteral">"Timestamp at end of run"</span>);
<a name="l00014"></a>00014   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"events"</span>, <a class="code" href="group__mc.html#g1b934fc84cf19c15cfc38d22cdd0868a">events</a>, <span class="stringliteral">"Number of events recorded during run"</span>);
<a name="l00015"></a>00015   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"livetime"</span>, <a class="code" href="group__mc.html#g7cdab28dd521186d398b2b456d6056aa">livetime</a>, 
<a name="l00016"></a>00016                     <span class="stringliteral">"Runtime scaled for number of accepted triggers"</span>);
<a name="l00017"></a>00017   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"type"</span>, <a class="code" href="group__mc.html#g185089f509a9e7f84fff532956d0bbff">type</a>, <span class="stringliteral">"Label giving purpose of run"</span>);
<a name="l00018"></a>00018   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"comment"</span>,<a class="code" href="group__mc.html#g6181cd5f6cec596c28553c64d9d18001">comment</a>,<span class="stringliteral">"Generic information about run"</span>);
<a name="l00019"></a>00019   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"drift_hv"</span>,<a class="code" href="group__mc.html#g0fba5f33ed38a4e05cbdbe664cb36de8">drift_hv</a>,<span class="stringliteral">"Setting of drift_hv field"</span>);
<a name="l00020"></a>00020   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"extraction_hv"</span>,<a class="code" href="group__mc.html#g2ef73b2d786a23aedbb9ef9b49b087c4">extraction_hv</a>,<span class="stringliteral">"Extraction field setting"</span>);
<a name="l00021"></a>00021   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"trigger_veto"</span>,<a class="code" href="group__mc.html#g62a06133a74a9aaba0aabeb66e8eafc7">trigger_veto</a>,
<a name="l00022"></a>00022                     <span class="stringliteral">"Length of per-trigger veto in ms; -1 to disable"</span>);
<a name="l00023"></a>00023   <a class="code" href="classParameterList.html#e5bf39e62a28e49b681674b5921c3353">RegisterFunction</a>(<a class="code" href="group__mc.html#g8a17a25927f06dd1ec5d317e8cb130c1">channel_inserter::GetFunctionName</a>(),
<a name="l00024"></a>00024                    <a class="code" href="classMC__RunInfo_1_1channel__inserter.html">channel_inserter</a>(<span class="keyword">this</span>), <a class="code" href="classMC__RunInfo_1_1channel__inserter.html">channel_inserter</a>(<span class="keyword">this</span>),
<a name="l00025"></a>00025                    <span class="stringliteral">"Insert a daq channel's info into the database"</span>);
<a name="l00026"></a>00026   <a class="code" href="classParameterList.html#1b8c5e9f442b45ea87cde1ac7674d47c">RegisterReadFunction</a>(<a class="code" href="group__mc.html#gb57ced2132f60e0d8c046181f5a87451">channel_clearer::GetFunctionName</a>(),
<a name="l00027"></a>00027                        <a class="code" href="classMC__RunInfo_1_1channel__clearer.html">channel_clearer</a>(<span class="keyword">this</span>),
<a name="l00028"></a>00028                        <span class="stringliteral">"Clear the list of channel info"</span>);
<a name="l00029"></a>00029 }
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="classMC__RunInfo_1_1channelinfo.html#e8b6cb483a5a9af611f8c46b1c751a04">00031</a> <a class="code" href="classMC__RunInfo_1_1channelinfo.html#e8b6cb483a5a9af611f8c46b1c751a04">MC_RunInfo::channelinfo::channelinfo</a>() :
<a name="l00032"></a>00032   <a class="code" href="classParameterList.html">ParameterList</a>(<span class="stringliteral">"channelinfo"</span>,<span class="stringliteral">"Information about the state of a daq channel for database insertion"</span>), 
<a name="l00033"></a>00033   channel(-1) , voltage(0), amplification(1), spe_mean(1), spe_sigma(0), calibration_run(-1),
<a name="l00034"></a>00034   calibration_channel(-1), cal_filters(2), reload_cal(false), 
<a name="l00035"></a>00035   reload_cal_run(false)
<a name="l00036"></a>00036 {
<a name="l00037"></a>00037 
<a name="l00038"></a>00038   <a class="code" href="group__mc.html#g18b3b93520e0197c8898792e7183def2">InitializeParameterList</a>();
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="group__mc.html#g18b3b93520e0197c8898792e7183def2">00042</a> <span class="keywordtype">void</span> <a class="code" href="group__mc.html#g18b3b93520e0197c8898792e7183def2">MC_RunInfo::channelinfo::InitializeParameterList</a>() {
<a name="l00043"></a>00043 
<a name="l00044"></a>00044   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"channel"</span>, <a class="code" href="group__mc.html#g3671f6cf7c5b49c087d1b96a8e2ef6b9">channel</a>, <span class="stringliteral">"Unique ID number"</span>);
<a name="l00045"></a>00045   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"voltage"</span>,<a class="code" href="group__mc.html#gf067db1f5d8997245319953c5877fdb3">voltage</a>, <span class="stringliteral">"High Voltage applied to PMT"</span>);
<a name="l00046"></a>00046   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"amplification"</span>, <a class="code" href="group__mc.html#g5d633dd5b9d3b78d296d1fb75b5b4a6e">amplification</a>, 
<a name="l00047"></a>00047                     <span class="stringliteral">"Amplification applied to channel after PMT output"</span>);
<a name="l00048"></a>00048   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"spe_mean"</span>,<a class="code" href="group__mc.html#g5c216f0cfd22197adf845151cf2cdfdd">spe_mean</a>,
<a name="l00049"></a>00049                     <span class="stringliteral">"Single photoelectron mean from calibration database"</span>);
<a name="l00050"></a>00050   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"spe_sigma"</span>,<a class="code" href="group__mc.html#gdcffaa1e24fd8c8f8b22e42adb9cdd1e">spe_sigma</a>,
<a name="l00051"></a>00051                     <span class="stringliteral">"Single photoelectron sigma from calibration database"</span>);
<a name="l00052"></a>00052   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"calibration_run"</span>, <a class="code" href="group__mc.html#g34836b82f18eef4d0bcfd0a0b55039f4">calibration_run</a>,
<a name="l00053"></a>00053                     <span class="stringliteral">"Run from which calibration data was loaded"</span>);
<a name="l00054"></a>00054   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"calibration_channel"</span>, <a class="code" href="group__mc.html#g2f68c5e172065bd80f56a761d5719cd3">calibration_channel</a>,
<a name="l00055"></a>00055                     <span class="stringliteral">"Channel which should be used for calibration data"</span>);
<a name="l00056"></a>00056   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"cal_filters"</span>, <a class="code" href="group__mc.html#ga4f8242ad7c33864f2ad11a8d1b656d3">cal_filters</a>,
<a name="l00057"></a>00057                     <span class="stringliteral">"Only consider runs with x filters for calibration"</span>);
<a name="l00058"></a>00058   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"reload_cal"</span>, <a class="code" href="group__mc.html#g0fb074955104c4f46f74f22024caaaa0">reload_cal</a>,
<a name="l00059"></a>00059                     <span class="stringliteral">"Search for calibration info in DB rather than saved vals"</span>);
<a name="l00060"></a>00060   <a class="code" href="classParameterList.html#3db08300f6dfab45123dd4e2db712d89">RegisterParameter</a>(<span class="stringliteral">"reload_cal_run"</span>, <a class="code" href="group__mc.html#g36beba50cf8257b0ebb7e8bece615c48">reload_cal_run</a>,
<a name="l00061"></a>00061                     <span class="stringliteral">"Search for new calibration run rather than previous one"</span>);
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00065"></a><a class="code" href="group__mc.html#g025532025553f356f8a94e1a1f3d3be9">00065</a> std::istream&amp; <a class="code" href="RunDB_8hh.html#38043c54d556cbbe3daa3372c2a04acf">operator&gt;&gt;</a>(std::istream&amp; in, <a class="code" href="structMC__RunInfo_1_1time__param.html">MC_RunInfo::time_param</a>&amp; t)
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067   std::string dummy;
<a name="l00068"></a>00068   in&gt;&gt;dummy;
<a name="l00069"></a>00069   <span class="keywordflow">if</span>(dummy[4] == <span class="charliteral">'-'</span>){
<a name="l00070"></a>00070     <span class="comment">//this is a string</span>
<a name="l00071"></a>00071     <span class="keywordtype">int</span> year, month, day;
<a name="l00072"></a>00072     sscanf(dummy.c_str(),<span class="stringliteral">"%4d-%2d-%2d"</span>,&amp;year, &amp;month, &amp;day);
<a name="l00073"></a>00073     in&gt;&gt;dummy;
<a name="l00074"></a>00074     <span class="keywordtype">int</span> hours, minutes, seconds;
<a name="l00075"></a>00075     sscanf(dummy.c_str(),<span class="stringliteral">"%2d:%2d:%2d"</span>, &amp;hours, &amp;minutes, &amp;seconds);
<a name="l00076"></a>00076     <span class="keyword">struct </span>tm timeinfo;
<a name="l00077"></a>00077     timeinfo.tm_sec = seconds;
<a name="l00078"></a>00078     timeinfo.tm_min = minutes;
<a name="l00079"></a>00079     timeinfo.tm_hour = hours;
<a name="l00080"></a>00080     timeinfo.tm_mday = day;
<a name="l00081"></a>00081     timeinfo.tm_mon = month-1;
<a name="l00082"></a>00082     timeinfo.tm_year = year-1900;
<a name="l00083"></a>00083     timeinfo.tm_isdst=-1;
<a name="l00084"></a>00084         
<a name="l00085"></a>00085     t.<a class="code" href="group__mc.html#g69eb0bb4a0fa6623255fd400e152b213">t</a> = timegm(&amp;timeinfo);
<a name="l00086"></a>00086     <span class="keywordflow">return</span> in;
<a name="l00087"></a>00087   }
<a name="l00088"></a>00088   <span class="comment">//if we get here, it should be an integer</span>
<a name="l00089"></a>00089   t.<a class="code" href="group__mc.html#g69eb0bb4a0fa6623255fd400e152b213">t</a> = atoi(dummy.c_str());
<a name="l00090"></a>00090   <span class="keywordflow">return</span> in;
<a name="l00091"></a>00091 }
<a name="l00093"></a><a class="code" href="group__mc.html#g3934d6ee22a96716032af38b6ae9a73c">00093</a> std::ostream&amp; <a class="code" href="RunDB_8hh.html#d534078c9373af93d221261ccfa45287">operator&lt;&lt;</a>(std::ostream&amp; out,<a class="code" href="structMC__RunInfo_1_1time__param.html">MC_RunInfo::time_param</a>&amp; t)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095   <span class="keywordtype">char</span> str[20];
<a name="l00096"></a>00096   std::strftime(str,20,<span class="stringliteral">"%Y-%m-%d %H:%M:%S"</span>,std::gmtime(&amp;t.<a class="code" href="group__mc.html#g69eb0bb4a0fa6623255fd400e152b213">t</a>));
<a name="l00097"></a>00097   out&lt;&lt;str;
<a name="l00098"></a>00098   <span class="keywordflow">return</span> out;
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="group__mc.html#g682fd6d5b65989d2b9a5eef9ec2c1183">00101</a> std::istream&amp; <a class="code" href="group__mc.html#g682fd6d5b65989d2b9a5eef9ec2c1183">MC_RunInfo::channel_clearer::operator()</a>(std::istream&amp; in)
<a name="l00102"></a>00102 {
<a name="l00103"></a>00103   <a class="code" href="classMC__RunInfo_1_1channel__clearer.html#5102c852da2b712c8d1c0f01fb0a0162">_parent</a>-&gt;<a class="code" href="group__mc.html#g6d404c4ba4db38090782a4dfbfc78b3c">channels</a>.clear();
<a name="l00104"></a>00104   <span class="keywordflow">return</span> in;
<a name="l00105"></a>00105 }  
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="group__mc.html#g1f0e6a919b2b5276d24ca85729c45eec">00107</a> std::istream&amp; <a class="code" href="group__mc.html#g1f0e6a919b2b5276d24ca85729c45eec">MC_RunInfo::channel_inserter::operator()</a>(std::istream&amp; in){
<a name="l00108"></a>00108   <a class="code" href="classMC__RunInfo_1_1channelinfo.html">channelinfo</a> info;
<a name="l00109"></a>00109   in&gt;&gt;info;
<a name="l00110"></a>00110   <span class="comment">//make sure it isn't there already</span>
<a name="l00111"></a>00111   <span class="keywordflow">for</span>(size_t i=0; i &lt; <a class="code" href="classMC__RunInfo_1_1channel__inserter.html#c0421cf22fcdecec8b6b515e0bf3f5c7">_parent</a>-&gt;<a class="code" href="group__mc.html#g6d404c4ba4db38090782a4dfbfc78b3c">channels</a>.size(); i++){
<a name="l00112"></a>00112     <span class="keywordflow">if</span>(<a class="code" href="classMC__RunInfo_1_1channel__inserter.html#c0421cf22fcdecec8b6b515e0bf3f5c7">_parent</a>-&gt;<a class="code" href="group__mc.html#g6d404c4ba4db38090782a4dfbfc78b3c">channels</a>[i].channel == info.channel){
<a name="l00113"></a>00113       <a class="code" href="classMC__RunInfo_1_1channel__inserter.html#c0421cf22fcdecec8b6b515e0bf3f5c7">_parent</a>-&gt;<a class="code" href="group__mc.html#g6d404c4ba4db38090782a4dfbfc78b3c">channels</a>[i] = info;
<a name="l00114"></a>00114       <span class="keywordflow">return</span> in;
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116   }
<a name="l00117"></a>00117   <a class="code" href="classMC__RunInfo_1_1channel__inserter.html#c0421cf22fcdecec8b6b515e0bf3f5c7">_parent</a>-&gt;<a class="code" href="group__mc.html#g6d404c4ba4db38090782a4dfbfc78b3c">channels</a>.push_back(info);
<a name="l00118"></a>00118   <span class="keywordflow">return</span> in;
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="group__mc.html#gd23ad9effd30cdfb0dcd553ee3518c9e">00121</a> std::ostream&amp; <a class="code" href="group__mc.html#g1f0e6a919b2b5276d24ca85729c45eec">MC_RunInfo::channel_inserter::operator()</a>(std::ostream&amp; out){
<a name="l00122"></a>00122   out&lt;&lt;<span class="stringliteral">"\n"</span>&lt;&lt;<a class="code" href="group__mc.html#gb57ced2132f60e0d8c046181f5a87451">channel_clearer::GetFunctionName</a>()&lt;&lt;<span class="stringliteral">" ,\n"</span>;
<a name="l00123"></a>00123   <span class="keywordflow">for</span>(size_t i=0; i &lt; <a class="code" href="classMC__RunInfo_1_1channel__inserter.html#c0421cf22fcdecec8b6b515e0bf3f5c7">_parent</a>-&gt;<a class="code" href="group__mc.html#g6d404c4ba4db38090782a4dfbfc78b3c">channels</a>.size(); i++){
<a name="l00124"></a>00124     out&lt;&lt;<a class="code" href="group__mc.html#g8a17a25927f06dd1ec5d317e8cb130c1">GetFunctionName</a>()&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;<a class="code" href="classMC__RunInfo_1_1channel__inserter.html#c0421cf22fcdecec8b6b515e0bf3f5c7">_parent</a>-&gt;<a class="code" href="group__mc.html#g6d404c4ba4db38090782a4dfbfc78b3c">channels</a>.at(i)&lt;&lt;<span class="stringliteral">" "</span>;
<a name="l00125"></a>00125   }
<a name="l00126"></a>00126   <span class="keywordflow">return</span> out;
<a name="l00127"></a>00127 }  
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 25 13:42:47 2013 for daqman by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
